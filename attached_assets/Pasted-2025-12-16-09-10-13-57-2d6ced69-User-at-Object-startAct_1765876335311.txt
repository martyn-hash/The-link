2025-12-16 09:10:13.57
2d6ced69
User
at Object.startActiveSpan (file:///home/runner/workspace/node_modules/drizzle-orm/tracing.js:8:14)
2025-12-16 09:10:13.57
2d6ced69
User
at PgSelectBase._prepare (file:///home/runner/workspace/node_modules/drizzle-orm/pg-core/query-builders/select.js:683:19)
2025-12-16 09:10:13.57
2d6ced69
User
at Array.reduce ()
2025-12-16 09:10:13.57
2d6ced69
User
at file:///home/runner/workspace/node_modules/drizzle-orm/utils.js:63:22
2025-12-16 09:10:13.57
2d6ced69
User
at Function.entries ()
2025-12-16 09:10:13.57
2d6ced69
User
at file:///home/runner/workspace/node_modules/drizzle-orm/pg-core/query-builders/select.js:684:26
2025-12-16 09:10:13.57
2d6ced69
User
at file:///home/runner/workspace/node_modules/drizzle-orm/pg-core/query-builders/select.js:708:19
2025-12-16 09:10:13.57
2d6ced69
User
at Object.startActiveSpan (file:///home/runner/workspace/node_modules/drizzle-orm/tracing.js:8:14)
2025-12-16 09:10:13.57
2d6ced69
User
at Array.reduce ()
2025-12-16 09:10:13.57
2d6ced69
User
at orderSelectedFields (file:///home/runner/workspace/node_modules/drizzle-orm/utils.js:53:33)
2025-12-16 09:10:13.57
2d6ced69
User
at file:///home/runner/workspace/node_modules/drizzle-orm/utils.js:63:22
2025-12-16 09:10:13.57
2d6ced69
User
at Object.startActiveSpan (file:///home/runner/workspace/node_modules/drizzle-orm/tracing.js:8:14)
2025-12-16 09:10:13.57
2d6ced69
User
at PgSelectBase._prepare (file:///home/runner/workspace/node_modules/drizzle-orm/pg-core/query-builders/select.js:683:19)
2025-12-16 09:10:13.57
2d6ced69
User
at orderSelectedFields (file:///home/runner/workspace/node_modules/drizzle-orm/utils.js:53:17)
2025-12-16 09:10:13.57
2d6ced69
User
at Function.entries ()
2025-12-16 09:10:13.57
2d6ced69
User
at file:///home/runner/workspace/node_modules/drizzle-orm/pg-core/query-builders/select.js:684:26
2025-12-16 09:10:13.57
2d6ced69
User
[QueryReminderCron] Error processing reminder c061c130-cf45-4f38-8902-e4b6be2d0912: TypeError: Cannot convert undefined or null to object
2025-12-16 09:10:23.99
2d6ced69
User
recipientName: 'ALLAN, Martyn Lewis',
2025-12-16 09:10:23.99
2d6ced69
User
scheduledAt: 2025-12-16T07:45:05.000Z,
2025-12-16 09:10:23.99
2d6ced69
User
recipientEmail: 'martyn@goimpartial.co.uk',
2025-12-16 09:10:23.99
2d6ced69
User
tokenId: '3d8e3f1e-34c9-497c-b3fd-4338207800d6',
2025-12-16 09:10:23.99
2d6ced69
User
recipientPhone: '07441392660',
2025-12-16 09:10:23.99
2d6ced69
User
}
2025-12-16 09:10:23.99
2d6ced69
User
[QueryReminder] Processing sms reminder 49016896-950a-4166-861a-52a59cf78dd8: {
2025-12-16 09:10:23.99
2d6ced69
User
projectId: '7823401a-051e-4a30-a1d4-d2530314101a'
2025-12-16 09:10:24.09
2d6ced69
User
at file:///home/runner/workspace/node_modules/drizzle-orm/pg-core/query-builders/select.js:684:26
2025-12-16 09:10:24.09
2d6ced69
User
at Array.reduce ()
2025-12-16 09:10:24.09
2d6ced69
User
at Object.startActiveSpan (file:///home/runner/workspace/node_modules/drizzle-orm/tracing.js:8:14)
2025-12-16 09:10:24.09
2d6ced69
User
at Object.startActiveSpan (file:///home/runner/workspace/node_modules/drizzle-orm/tracing.js:8:14)
2025-12-16 09:10:24.09
2d6ced69
User
at orderSelectedFields (file:///home/runner/workspace/node_modules/drizzle-orm/utils.js:53:17)
2025-12-16 09:10:24.09
2d6ced69
User
at orderSelectedFields (file:///home/runner/workspace/node_modules/drizzle-orm/utils.js:53:33)
2025-12-16 09:10:24.09
2d6ced69
User
[QueryReminderCron] Error processing reminder 49016896-950a-4166-861a-52a59cf78dd8: TypeError: Cannot convert undefined or null to object
2025-12-16 09:10:24.09
2d6ced69
User
at PgSelectBase._prepare (file:///home/runner/workspace/node_modules/drizzle-orm/pg-core/query-builders/select.js:683:19)

2025-12-16 09:10:24.09
2d6ced69
User
at file:///home/runner/workspace/node_modules/drizzle-orm/utils.js:63:22
2025-12-16 09:10:24.09
2d6ced69
User
at file:///home/runner/workspace/node_modules/drizzle-orm/pg-core/query-builders/select.js:708:19
2025-12-16 09:10:24.09
2d6ced69
User
at Function.entries ()
2025-12-16 09:10:24.41
2d6ced69
User
[Database Pool] New connection established
2025-12-16 09:10:24.50
2d6ced69
User
9:10:24 AM [express] GET /api/project-messages/unread-count 200 in 541ms :: {"unreadCount":0}
2025-12-16 09:10:35.55
2d6ced69
User
[CronTelemetry] Event loop delay: min=12.9ms, p50=20.12ms, p95=20.22ms, max=9806.28ms
2025-12-16 09:11:25.11
2d6ced69
User
[Database Pool] New connection established
2025-12-16 09:11:25.31
2d6ced69
User
[Database Pool] New connection established
2025-12-16 09:11:25.40
2d6ced69
User
9:11:25 AM [express] GET /api/project-messages/unread-count 200 in 652ms :: {"unreadCount":0}

Collapse

Wrap

Colors

Live
Security and Privacy Scanner
Beta
Run a scan to check for potential security risks and privacy leaks in your application. Scans are typically complete within minutes. Learn more

Run scan

Scan settings
13 potential vulnerabilities found.
Last ran on
 
11:23 pm, Dec 15, 2025
Security
Outdated dependencies have known vulnerabilities

There are dependencies that have vulnerabilities and may need to be updated.
These dependencies can be updated automatically.
glob@10.4.5
jws@3.2.2
jws@4.0.0

Hide

Update automatically

Fix with Agent
Security
Dependency has known vulnerabilities

This dependency has known vulnerabilities and may need to be replaced with something else. You can have the Agent update them for you and make any necessary changes.
xlsx@0.18.5

Hide

Fix with Agent
Security
Dependency has known vulnerabilities

This dependency has known vulnerabilities and may need to be replaced with something else. You can have the Agent update them for you and make any necessary changes.
xlsx@0.18.5

Hide

Fix with Agent
Security
Google API Key detected. Avoid hardcoding credentials directly in connection strings as this creates security risks. Instead, use environment variables to store and access credentials at runtime. If you need the actual credential values to make this work properly, ask me to provide them through Replit's secret system.


Hide

Fix with Agent
Security
A gitleaks Generic API Key detected. Avoid hardcoding credentials directly in connection strings as this creates security risks. Instead, use environment variables to store and access credentials at runtime. If you need the actual credential values to make this work properly, ask me to provide them through Replit's secret system.


Hide

Fix with Agent
Security
XSS Vulnerability: Unsafe DOM Manipulation. User controlled data in methods like `innerHTML`, `outerHTML` or `document.write` is an anti-pattern that can lead to XSS vulnerabilities. Replace with safe DOM methods: Use createElement() + appendChild() + textContent for dynamic content. Avoid use innerHTML with user data: Even escaped data can be risky. If HTML injection is absolutely necessary: Sanitize with DOMPurify library first.


Hide

Fix with Agent
Security
XSS Vulnerability: Unsafe DOM Manipulation. User controlled data in methods like `innerHTML`, `outerHTML` or `document.write` is an anti-pattern that can lead to XSS vulnerabilities. Replace with safe DOM methods: Use createElement() + appendChild() + textContent for dynamic content. Avoid use innerHTML with user data: Even escaped data can be risky. If HTML injection is absolutely necessary: Sanitize with DOMPurify library first.


Hide

Fix with Agent
Security
Bcrypt Hash detected. Avoid hardcoding credentials directly in connection strings as this creates security risks. Instead, use environment variables to store and access credentials at runtime. If you need the actual credential values to make this work properly, ask me to provide them through Replit's secret system.


Hide

Fix with Agent
Security
Bcrypt Hash detected. Avoid hardcoding credentials directly in connection strings as this creates security risks. Instead, use environment variables to store and access credentials at runtime. If you need the actual credential values to make this work properly, ask me to provide them through Replit's secret system.


Hide

Fix with Agent
Security
Detected user input used to manually construct a SQL string. This is usually bad practice because manual construction could accidentally result in a SQL injection. An attacker could use a SQL injection to steal or modify contents of the database. Instead, use a parameterized query which is available by default in most database engines. Alternatively, consider using an object-relational mapper (ORM) such as Sequelize which will protect your queries.


Hide

Fix with Agent
Security
Detected user input used to manually construct a SQL string. This is usually bad practice because manual construction could accidentally result in a SQL injection. An attacker could use a SQL injection to steal or modify contents of the database. Instead, use a parameterized query which is available by default in most database engines. Alternatively, consider using an object-relational mapper (ORM) such as Sequelize which will protect your queries.


Hide

Fix with Agent
Security
The call to 'createDecipheriv' with the Galois Counter Mode (GCM) mode of operation is missing an expected authentication tag length. If the expected authentication tag length is not specified or otherwise checked, the application might be tricked into verifying a shorter-than-expected authentication tag. This can be abused by an attacker to spoof ciphertexts or recover the implicit authentication key of GCM, allowing arbitrary forgeries.


Hide

Fix with Agent
Privacy
Password sent to Standard Output


Hide

Fix with Agent
Vulnerability scans are enabled by the following Replit partners:
Security scans are powered by Semgrep Community Edition.
Privacy scans are powered by HoundDog.ai.
Security scanning powered by Semgrep and privacy scanning powered by HoundDog.ai , both running locally on Replit infrastructure. No code or data is transmitted to any third party, including Semgrep or HoundDog.ai.

npm run dev

Ask Agentâ€¦
18m
 â€¢ 
18 minutes ago

Queries Module Improvements Plan
Created: December 10, 2025
Status: In Progress
Priority: High
Last Updated: December 10, 2025

Progress Log
December 10, 2025 - Stage 1 Bug Fixes
1.1 Notify Button Fix - COMPLETED âœ…
Root Cause: The /api/projects/:projectId/assignees route was using req.effectiveUser directly, but the resolveEffectiveUser middleware sets the effective user on req.user.effectiveUser. This caused the route to fail silently (no user found) and return an empty array.

Fix Applied:

Changed req.effectiveUser to req.user?.effectiveUser in the assignees route
Changed req.effectiveUserId to req.user?.effectiveUserId for consistency
Added loading skeleton UI when data is still being fetched (in QueriesTab.tsx)
Files Modified:

server/routes/projects/assignees.ts - Fixed middleware property access
client/src/components/queries/QueriesTab.tsx - Added loading state
1.2 Cancel All Pending Button Fix - COMPLETED âœ…
Root Cause: Two issues identified:

TokenIds could contain null/undefined values, causing the array filter to fail
AlertDialog backdrop clicks were propagating to parent Kanban modal elements
Fix Applied:

Added proper type guard filter for tokenIds: .filter((id): id is string => !!id)
Added canCancelAll computed value that checks tokenIds.length > 0
Wrapped AlertDialog in a div with onPointerDown and onClick stopPropagation handlers
Added proper null check before calling mutation
Files Modified:

client/src/components/queries/ScheduledRemindersPanel.tsx
December 10, 2025 - Stage 2 Enhanced Filtering - COMPLETED âœ…
2.1 Description Search Filter - COMPLETED âœ…
Added debounced search input (300ms) for filtering queries by description or query text
Case-insensitive search across description and ourQuery fields
Clear button to reset search
Result count display when filtering
2.2 Money In/Out Filter - COMPLETED âœ…
Added dropdown filter for transaction direction
Options: All Amounts, Money In, Money Out
Visual indicators with green/red colors
Files Modified:

client/src/components/queries/QueriesTab.tsx
December 10, 2025 - Stage 3 Query Grouping - COMPLETED âœ…
3.1 Database Schema - COMPLETED âœ…
Created query_groups table with id, projectId, groupName, description, createdById, createdAt
Added groupId foreign key to bookkeeping_queries table
Added proper indexes for performance
3.2 Manual Grouping Feature - COMPLETED âœ…
"Group Selected" button when queries are selected
Create group dialog with name and optional description
Add/remove queries from groups via dropdown menu
Visual badge indicators showing group membership
3.3 Client Response Page Grouping - COMPLETED âœ…
Group badges visible on client response page
Queries organized by group visually
3.4 Group Filter Dropdown - COMPLETED âœ…
Filter dropdown appears when groups exist
Options: All Groups, Ungrouped, [Individual group names]
Filters queries in real-time
3.5 HTML Email Table Grouping - COMPLETED âœ…
Email table organizes queries by group with visual headers
Blue highlighted header rows for each group showing name and count
Ungrouped queries appear at the end
Files Modified:

shared/schema/queries/tables.ts - Schema changes
shared/schema/queries/types.ts - TypeScript types
server/storage/queries/queryStorage.ts - Storage functions
server/routes/queries.ts - API routes and email generation
client/src/components/queries/QueriesTab.tsx - UI components
client/src/pages/query-response.tsx - Client page
3.6 Kanban Modal Scroll Enhancement - COMPLETED âœ…
Increased QueriesForm max-height from 300px to 50vh for better visibility
Files Modified:

client/src/components/change-status/QueriesForm.tsx
December 10, 2025 - Stage 4 Auto-Grouping Algorithm - COMPLETED âœ…
4.1 Backend Auto-Group Endpoints - COMPLETED âœ…
POST /api/projects/:projectId/queries/auto-group/propose - Analyzes ungrouped queries by prefix matching
POST /api/projects/:projectId/queries/auto-group/apply - Bulk creates groups from accepted proposals
Normalization: lowercase, special chars removed, whitespace normalized before prefix matching
Returns proposals with matchedPrefix, proposedName, queryIds, and query details
4.2 Prefix Length Selector UI - COMPLETED âœ…
Dialog opens when "Auto-Group" button clicked
Number stepper with +/- buttons for prefix length (range: 3-20, default: 6)
"Find Groups" button triggers analysis
4.3 Auto-Group Review Dialog - COMPLETED âœ…
Shows all proposals with:
Per-group checkbox to include/exclude entire group
Editable group name input
Badge showing selected/total query count
Expandable list of queries with individual checkboxes
Unique key generation: ${matchedPrefix}_${firstQueryId} for stable React keys and state management
State synchronization between selectedProposals, proposalNames, and proposalQuerySelections
4.4 Bulk Group Creation - COMPLETED âœ…
"Create Groups" button builds payload from live state
Only includes selected groups with their selected queries
Uses edited names if provided, otherwise proposed names
Cache invalidation for both queries and query-groups
Key Technical Decisions:

Unique key derivation prevents state collision when multiple proposals share similar prefixes
Proposal state uses three separate maps for maximum flexibility in editing
Auto-Group button only visible when 2+ ungrouped queries exist
Files Modified:

server/routes/queries.ts - Backend endpoints
client/src/components/queries/QueriesTab.tsx - Frontend UI and state management
Executive Summary
This document outlines the implementation plan for improving the Bookkeeping Queries module based on staff feedback. The main themes are:

Query Grouping - Reduce client overwhelm by grouping related transactions (e.g., all queries for the same supplier/customer)
Enhanced Filtering - Allow staff to quickly find and manage related queries
Notification Improvements - Fix existing bugs and add assignee notification when clients respond
Bug Fixes - Address issues with the Notify button and Cancel All Pending button in Kanban modal
Auto-Suggest Answers - Surface previously answered similar queries to avoid asking clients the same questions
Current Architecture Overview
Database Schema
bookkeeping_queries - Core query table with projectId, description, moneyIn/Out, status, etc.
query_response_tokens - Tokens for client response links, tracks queryIds array
scheduled_query_reminders - Scheduled email/SMS/voice reminders linked to tokens
Key Components
Frontend: QueriesTab.tsx, ScheduledRemindersPanel.tsx, query-response.tsx (client-facing)
Backend: server/routes/queries.ts, server/storage/queries/queryStorage.ts
Services: queryReminderService.ts, notification-sender.ts
Stage 1: Bug Fixes (Priority: Critical)
1.1 Fix "Notify" Button Not Finding Assignees
Problem: The Notify button in the Queries tab shows no assignees to notify when clicked.

Root Cause Analysis: The projectAssignees query is only enabled when isNotifyDialogOpen is true. The query fetches from /api/projects/:projectId/assignees which returns project assignments with nested user data.

// Current code in QueriesTab.tsx (line 265-275)
const { data: projectAssignees } = useQuery<{
  id: string;
  projectId: string;
  userId: string;
  roleId: string | null;
  user: { id: string; firstName: string | null; lastName: string | null; email: string };
  role: { id: string; name: string } | null;
}[]>({
  queryKey: ['/api/projects', projectId, 'assignees'],
  enabled: isNotifyDialogOpen,
});

Investigation Required:

Verify the /api/projects/:projectId/assignees endpoint returns the correct data structure
Check if the project has assignees in the database
Ensure the dialog correctly maps and displays the assignees
Fix Steps:

Add logging/debugging to confirm API response
Verify the Notify dialog renders the assignees list correctly
Check if there's a timing issue (dialog opens before data loads)
Add loading state to the dialog while assignees are being fetched
Estimated Effort: 2-4 hours

1.2 Fix "Cancel All Pending" Button in Kanban Modal
Problem: The "Cancel All Pending" button works on the project detail page but not in the Kanban card modal.

Root Cause Analysis: The ScheduledRemindersPanel component is rendered inside the MessagesModal which is displayed from Kanban cards. The cancel functionality calls:

// ScheduledRemindersPanel.tsx (line 180-198)
const cancelAllMutation = useMutation({
  mutationFn: async (tokenId: string) => {
    return apiRequest('POST', `/api/query-tokens/${tokenId}/cancel-reminders`);
  },
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ['/api/projects', projectId, 'query-reminders'] });
    // ...
  },
});

Potential Issues:

The tokenId might not be correctly passed from the reminders data
The modal context may not have the same project ID as expected
Cache invalidation may be using wrong query keys
Investigation Required:

Verify tokenIds array is correctly populated in the modal context
Check if hasMultipleTokens logic is incorrectly hiding the button
Confirm the API call is being made with correct parameters
Fix Steps:

Add console logging to trace the cancel flow in the modal
Verify tokenId is available when button is clicked
Check network requests to confirm API calls are made
Ensure error messages are displayed if the call fails
Estimated Effort: 2-4 hours

Stage 2: Enhanced Filtering (Priority: High)
2.1 Add Description Search Filter
Feature: Allow staff to search queries by description text to quickly find all transactions from the same supplier/customer.

UI Design:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [All Statuses â–¼]  [ğŸ” Search descriptions...              ]    â”‚
â”‚                                                                 â”‚
â”‚ Results: 15 queries matching "Barclays"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Implementation:

Frontend Changes (QueriesTab.tsx):

const [searchTerm, setSearchTerm] = useState("");
const filteredQueries = useMemo(() => {
  let result = queries || [];
  
  // Status filter
  if (filterStatus !== "all") {
    result = result.filter(q => q.status === filterStatus);
  }
  
  // Description search (case-insensitive)
  if (searchTerm.trim()) {
    const term = searchTerm.toLowerCase();
    result = result.filter(q => 
      q.description?.toLowerCase().includes(term) ||
      q.ourQuery?.toLowerCase().includes(term)
    );
  }
  
  return result;
}, [queries, filterStatus, searchTerm]);

Add Search Input Component:

Debounced input (300ms) to avoid excessive re-renders
Clear button to reset search
Show result count when searching
Estimated Effort: 3-4 hours

2.2 Add Money In/Out Filter
Feature: Allow filtering queries by transaction direction (money in vs money out).

UI Design:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [All Statuses â–¼]  [All Amounts â–¼]  [ğŸ” Search...          ]    â”‚
â”‚                    â”œâ”€ All Amounts                               â”‚
â”‚                    â”œâ”€ Money In                                  â”‚
â”‚                    â””â”€ Money Out                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Implementation:

Add Filter State:

const [amountFilter, setAmountFilter] = useState<"all" | "in" | "out">("all");

Apply Filter:

if (amountFilter === "in") {
  result = result.filter(q => q.moneyIn && parseFloat(q.moneyIn) > 0);
} else if (amountFilter === "out") {
  result = result.filter(q => q.moneyOut && parseFloat(q.moneyOut) > 0);
}

Estimated Effort: 1-2 hours

Stage 3: Query Grouping (Priority: High)
3.1 Database Schema Changes
New Table: query_groups

CREATE TABLE query_groups (
  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id VARCHAR NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  group_name VARCHAR(255) NOT NULL,
  description TEXT,
  created_by_id VARCHAR NOT NULL REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_query_groups_project_id ON query_groups(project_id);

Add Column to bookkeeping_queries:

ALTER TABLE bookkeeping_queries 
ADD COLUMN group_id VARCHAR REFERENCES query_groups(id) ON DELETE SET NULL;
CREATE INDEX idx_bookkeeping_queries_group_id ON bookkeeping_queries(group_id);

Drizzle Schema (shared/schema/queries/tables.ts):

export const queryGroups = pgTable("query_groups", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  projectId: varchar("project_id").notNull().references(() => projects.id, { onDelete: "cascade" }),
  groupName: varchar("group_name", { length: 255 }).notNull(),
  description: text("description"),
  createdById: varchar("created_by_id").notNull().references(() => users.id),
  createdAt: timestamp("created_at").defaultNow(),
}, (table) => [
  index("idx_query_groups_project_id").on(table.projectId),
]);
// Update bookkeepingQueries table to add groupId
groupId: varchar("group_id").references(() => queryGroups.id, { onDelete: "set null" }),

Estimated Effort: 2-3 hours

3.2 Manual Grouping Feature
User Flow:

Staff searches for "Barclays" in the description filter
System shows all matching queries
Staff selects the queries they want to group
Staff clicks "Group Selected" button
Dialog prompts for group name (auto-suggested: "Barclays")
Queries are linked to the new group
UI Design:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ” Barclays                    ]   [Clear]                     â”‚
â”‚ Showing 8 queries matching "Barclays"                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜‘ Select All                                                    â”‚
â”‚                                                                 â”‚
â”‚ [3 selected]  [Group Selected â–¼]  [Send to Client]  [Resolve]   â”‚
â”‚               â”œâ”€ Create New Group...                            â”‚
â”‚               â””â”€ Add to Existing Group â–º                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Create Group Dialog:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create Query Group                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Group Name: [Barclays                              ]           â”‚
â”‚                                                                 â”‚
â”‚  Description (optional):                                        â”‚
â”‚  [All queries related to Barclays bank account    ]             â”‚
â”‚                                                                 â”‚
â”‚  Queries to include: 8                                          â”‚
â”‚                                                                 â”‚
â”‚  [Cancel]                               [Create Group]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Backend API:

// POST /api/projects/:projectId/query-groups
interface CreateGroupRequest {
  groupName: string;
  description?: string;
  queryIds: string[];
}
// PATCH /api/query-groups/:groupId
interface UpdateGroupRequest {
  groupName?: string;
  description?: string;
  queryIds?: string[]; // Add queries to group
}
// DELETE /api/query-groups/:groupId
// Removes the group, queries are unlinked (groupId set to null)
// PATCH /api/queries/:queryId/group
interface UpdateQueryGroupRequest {
  groupId: string | null; // null to remove from group
}

Estimated Effort: 8-10 hours

3.3 Grouped View for Client Response Page
Problem: When queries are grouped, the client should see ONE card per group instead of separate cards for each transaction.

Client View Design (Mobile - Grouped):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Query 1 of 3                                       [Barclays]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“¦ Group: Barclays (5 transactions)                            â”‚
â”‚                                                                 â”‚
â”‚  [View All 5 Transactions â–¼]                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 15 Nov  Barclays Bank Interest  Â£12.50 in                  â”‚â”‚
â”‚  â”‚ 18 Nov  Barclays Bank Fee       Â£15.00 out                 â”‚â”‚
â”‚  â”‚ 22 Nov  Barclays Transfer       Â£500.00 in                 â”‚â”‚
â”‚  â”‚ 25 Nov  Barclays DD             Â£45.00 out                 â”‚â”‚
â”‚  â”‚ 28 Nov  Barclays Refund         Â£25.00 in                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  Our Question:                                                  â”‚
â”‚  "Please confirm the nature of these Barclays transactions"     â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Your Response:                                              â”‚â”‚
â”‚  â”‚ [These are all normal bank transactions...]                 â”‚â”‚
â”‚  â”‚                                                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“ Attach Receipt/Invoice                                      â”‚
â”‚                                                                 â”‚
â”‚  [â† Previous]    [Next â†’]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Implementation:

Backend Changes:

Modify getQueriesForToken to return grouped data
Add group information to the response
Frontend Changes (query-response.tsx):

Detect grouped queries
Render collapsible transaction list for groups
Single response field applies to all queries in group
When client submits, response is saved to all queries in group
Data Structure for Client Response:

interface GroupedQuery {
  groupId: string;
  groupName: string;
  queries: Query[];
  ourQuery: string; // Consolidated query text
}
interface TokenData {
  // ... existing fields
  queries: Query[];
  groupedQueries: GroupedQuery[]; // For grouped items
  ungroupedQueries: Query[]; // For non-grouped items
}

Estimated Effort: 10-12 hours

3.4 Edit/Remove Queries from Groups
Features:

View all groups for a project
Edit group name/description
Add/remove individual queries from a group
Delete entire group (queries remain, just unlinked)
UI Location: Add "Manage Groups" button to QueriesTab header

Manage Groups Panel:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Query Groups                                        [+ New]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“¦ Barclays (5 queries)                        [Edit] [Delete] â”‚
â”‚  ğŸ“¦ Amazon Purchases (3 queries)                [Edit] [Delete] â”‚
â”‚  ğŸ“¦ Travel Expenses (8 queries)                 [Edit] [Delete] â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Edit Group Dialog:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit Group: Barclays                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Name: [Barclays                                    ]           â”‚
â”‚                                                                 â”‚
â”‚  Queries in this group:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ â˜‘ 15 Nov - Barclays Bank Interest - Â£12.50     [Remove]    â”‚â”‚
â”‚  â”‚ â˜‘ 18 Nov - Barclays Bank Fee - Â£15.00          [Remove]    â”‚â”‚
â”‚  â”‚ â˜‘ 22 Nov - Barclays Transfer - Â£500.00         [Remove]    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  [+ Add Queries to Group]                                       â”‚
â”‚                                                                 â”‚
â”‚  [Cancel]                                   [Save Changes]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Estimated Effort: 6-8 hours

Stage 4: Auto-Grouping Feature (Priority: Medium)
4.1 Auto-Group Algorithm
Feature: System analyzes query descriptions and proposes groupings based on common prefixes/patterns.

Algorithm:

function autoGroupQueries(queries: Query[]): ProposedGroup[] {
  const groups: Map<string, Query[]> = new Map();
  const MIN_PREFIX_LENGTH = 4;
  const MIN_GROUP_SIZE = 2;
  
  // Normalize descriptions
  const normalizedQueries = queries.map(q => ({
    ...q,
    normalizedDesc: normalizeDescription(q.description || "")
  }));
  
  // Find common prefixes
  for (const query of normalizedQueries) {
    if (!query.normalizedDesc) continue;
    
    // Try different prefix lengths (from 4 to 20 chars)
    for (let len = MIN_PREFIX_LENGTH; len <= Math.min(20, query.normalizedDesc.length); len++) {
      const prefix = query.normalizedDesc.substring(0, len);
      
      if (!groups.has(prefix)) {
        groups.set(prefix, []);
      }
      groups.get(prefix)!.push(query);
    }
  }
  
  // Filter to groups with minimum size and select longest useful prefix
  const validGroups = selectBestGroups(groups, MIN_GROUP_SIZE);
  
  return validGroups.map(g => ({
    proposedName: extractGroupName(g.prefix),
    queries: g.queries,
    matchedPrefix: g.prefix
  }));
}
function normalizeDescription(desc: string): string {
  return desc
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, '') // Remove special chars
    .replace(/\s+/g, ' ')        // Normalize whitespace
    .trim();
}
function extractGroupName(prefix: string): string {
  // Convert "barclays bank" to "Barclays Bank"
  return prefix
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

Estimated Effort: 6-8 hours

4.2 Auto-Group UI
User Flow:

Staff clicks "Auto-Group" button
System analyzes all ungrouped queries
System presents proposed groupings for review
Staff can:
Accept a grouping (creates the group)
Reject a grouping (dismissed)
Remove individual queries from a proposed group
Edit the proposed group name
Staff confirms selections
Auto-Group Review Dialog:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”® Proposed Groupings                                          â”‚
â”‚  We found 4 potential groups from 23 ungrouped queries          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â˜‘ Barclays Bank (6 queries)                     [Rename]  â”‚ â”‚
â”‚  â”‚   â”œâ”€ â˜‘ 15 Nov - Barclays Bank Interest - Â£12.50           â”‚ â”‚
â”‚  â”‚   â”œâ”€ â˜‘ 18 Nov - Barclays Bank Fee - Â£15.00                â”‚ â”‚
â”‚  â”‚   â”œâ”€ â˜‘ 22 Nov - Barclays Bank Transfer - Â£500.00          â”‚ â”‚
â”‚  â”‚   â”œâ”€ â˜ 23 Nov - Barclays Card Payment - Â£25.00  â† Remove  â”‚ â”‚
â”‚  â”‚   â”œâ”€ â˜‘ 25 Nov - Barclays Bank DD - Â£45.00                 â”‚ â”‚
â”‚  â”‚   â””â”€ â˜‘ 28 Nov - Barclays Bank Refund - Â£25.00             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â˜‘ Amazon (4 queries)                            [Rename]  â”‚ â”‚
â”‚  â”‚   â”œâ”€ â˜‘ 10 Nov - Amazon Prime - Â£9.99                      â”‚ â”‚
â”‚  â”‚   â”œâ”€ â˜‘ 12 Nov - Amazon Marketplace - Â£45.00               â”‚ â”‚
â”‚  â”‚   â”œâ”€ â˜‘ 20 Nov - Amazon Web Services - Â£150.00             â”‚ â”‚
â”‚  â”‚   â””â”€ â˜‘ 25 Nov - Amazon Refund - Â£15.00                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â˜ TFL Travel (3 queries) â† Reject entire group            â”‚ â”‚
â”‚  â”‚   ...                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  [Cancel]                       [Create 2 Selected Groups]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Backend API:

// POST /api/projects/:projectId/queries/auto-group/propose
// Returns proposed groupings without creating them
interface AutoGroupProposeResponse {
  proposals: {
    proposedName: string;
    queryIds: string[];
    matchedPrefix: string;
  }[];
  ungroupableCount: number; // Queries that don't match any pattern
}
// POST /api/projects/:projectId/queries/auto-group/apply
// Creates the confirmed groups
interface AutoGroupApplyRequest {
  groups: {
    groupName: string;
    queryIds: string[];
  }[];
}

Estimated Effort: 8-10 hours

Stage 5: Auto-Suggest Answers (Priority: High) - NEW
Overview
When a bookkeeper creates a query for a transaction, the system should check if similar transactions have been queried and answered before. If a match is found, surface the previous answer to the staff member so they can either:

Use the existing answer (avoiding unnecessary client contact)
Learn from how similar queries were resolved previously
This reduces client fatigue by not asking about the same supplier/transaction type multiple times.

5.1 Database Schema Changes
New Table: query_answer_history

CREATE TABLE query_answer_history (
  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id VARCHAR NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  client_id VARCHAR REFERENCES clients(id) ON DELETE SET NULL,
  project_id VARCHAR REFERENCES projects(id) ON DELETE SET NULL,
  
  -- Matching fields
  description_prefix VARCHAR(100) NOT NULL,  -- First N characters of normalized description
  money_direction VARCHAR(10),  -- 'in', 'out', or null for either
  
  -- Answer details
  answer_text TEXT NOT NULL,
  answered_by_type VARCHAR(20) NOT NULL,  -- 'staff' or 'client'
  answered_by_id VARCHAR,
  answered_at TIMESTAMP NOT NULL,
  
  -- Original query reference
  source_query_id VARCHAR NOT NULL REFERENCES bookkeeping_queries(id) ON DELETE CASCADE,
  
  created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_query_answer_history_company_prefix ON query_answer_history(company_id, description_prefix);
CREATE INDEX idx_query_answer_history_client_prefix ON query_answer_history(client_id, description_prefix);

Add Setting for Match Threshold:

-- Add to company_settings or bookkeeping_settings
ALTER TABLE company_settings ADD COLUMN query_suggestion_prefix_length INTEGER DEFAULT 10;
ALTER TABLE company_settings ADD COLUMN query_suggestion_enabled BOOLEAN DEFAULT true;

Drizzle Schema:

export const queryAnswerHistory = pgTable("query_answer_history", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  companyId: varchar("company_id").notNull().references(() => companies.id, { onDelete: "cascade" }),
  clientId: varchar("client_id").references(() => clients.id, { onDelete: "set null" }),
  projectId: varchar("project_id").references(() => projects.id, { onDelete: "set null" }),
  
  descriptionPrefix: varchar("description_prefix", { length: 100 }).notNull(),
  moneyDirection: varchar("money_direction", { length: 10 }),
  
  answerText: text("answer_text").notNull(),
  answeredByType: varchar("answered_by_type", { length: 20 }).notNull(),
  answeredById: varchar("answered_by_id"),
  answeredAt: timestamp("answered_at").notNull(),
  
  sourceQueryId: varchar("source_query_id").notNull().references(() => bookkeepingQueries.id, { onDelete: "cascade" }),
  createdAt: timestamp("created_at").defaultNow(),
}, (table) => [
  index("idx_query_answer_history_company_prefix").on(table.companyId, table.descriptionPrefix),
  index("idx_query_answer_history_client_prefix").on(table.clientId, table.descriptionPrefix),
]);

Estimated Effort: 3-4 hours

5.2 Matching Algorithm
Normalization Function:

function normalizeDescription(description: string): string {
  return description
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, '')  // Remove special characters
    .replace(/\s+/g, ' ')         // Normalize whitespace
    .trim();
}
function getDescriptionPrefix(description: string, prefixLength: number): string {
  const normalized = normalizeDescription(description);
  return normalized.substring(0, Math.min(prefixLength, normalized.length));
}

Matching Logic:

When viewing a query, compute its description prefix
Search query_answer_history for matching prefixes
Optionally filter by money direction (in/out) for more precise matches
Score results by:
Same client > same company
More recent answers > older answers
Exact prefix match > partial match
Configuration Options (Admin Settings):

querySuggestionPrefixLength: Number of characters to match (default: 10)
querySuggestionEnabled: Enable/disable feature (default: true)
querySuggestionScope: 'company' | 'client' | 'both' (default: 'both')
querySuggestionMatchDirection: Match money in/out direction (default: false)
Estimated Effort: 4-6 hours

5.3 Backend API
// GET /api/projects/:projectId/queries/:queryId/suggestions
// Returns suggested answers for a specific query
interface QuerySuggestionsResponse {
  suggestions: {
    id: string;
    answerText: string;
    answeredByType: 'staff' | 'client';
    answeredByName?: string;
    answeredAt: string;
    matchScore: number;  // 0-100, higher = better match
    sourceDescription: string;  // Original transaction description
    sourceQueryText?: string;  // Original query question
    clientName?: string;  // For cross-client matches
  }[];
  matchedPrefix: string;
  settings: {
    prefixLength: number;
  };
}
// POST /api/queries/:queryId/apply-suggestion
// Copy a suggested answer to the query
interface ApplySuggestionRequest {
  suggestionId: string;
  answerText: string;  // May be edited by staff
}
// POST /api/admin/query-suggestion-settings
// Update suggestion settings
interface UpdateSuggestionSettingsRequest {
  prefixLength?: number;
  enabled?: boolean;
  scope?: 'company' | 'client' | 'both';
  matchDirection?: boolean;
}

Auto-Record Answers: When a query is answered (by staff or client), automatically create a record in query_answer_history:

// In the answer submission logic:
await storage.createQueryAnswerHistory({
  companyId: project.companyId,
  clientId: project.clientId,
  projectId: project.id,
  descriptionPrefix: getDescriptionPrefix(query.description, settings.prefixLength),
  moneyDirection: query.moneyIn ? 'in' : query.moneyOut ? 'out' : null,
  answerText: response.answer,
  answeredByType: isStaff ? 'staff' : 'client',
  answeredById: userId,
  answeredAt: new Date(),
  sourceQueryId: query.id,
});

Estimated Effort: 6-8 hours

5.4 Frontend UI
UI Design - Suggestion Icon in Table:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜ â”‚ Date      â”‚ Description          â”‚ In     â”‚ Out    â”‚ Query         â”‚ Actâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜ â”‚ 15 Nov    â”‚ Barclays Interest    â”‚ Â£12.50 â”‚ -      â”‚ What is this? â”‚ âœ¨ â”‚
â”‚ â˜ â”‚ 18 Nov    â”‚ Amazon Purchase      â”‚ -      â”‚ Â£45.00 â”‚ What is this? â”‚    â”‚
â”‚ â˜ â”‚ 22 Nov    â”‚ Barclays Transfer    â”‚ Â£500   â”‚ -      â”‚ What is this? â”‚ âœ¨ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âœ¨ = Suggestion available (magic wand or lightbulb icon)

Suggestion Panel (on click of icon):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¡ Similar Query Found                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Transaction: Barclays Interest - Â£12.50                        â”‚
â”‚                                                                 â”‚
â”‚  Previously Asked: "What is this bank interest payment?"        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Previous Answer (from ABC Ltd, 2 months ago):             â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  "This is monthly interest from our business account.      â”‚â”‚
â”‚  â”‚   Please categorise as bank interest income."              â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚                                         [Use This Answer]  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  Match Confidence: 95% (same description prefix)                â”‚
â”‚  Answer provided by: Client (Sarah Smith)                       â”‚
â”‚                                                                 â”‚
â”‚  [Mark as Not Relevant]              [Close]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Use Answer Flow:

Click "Use This Answer" â†’ opens answer input pre-filled with text
Staff can edit before saving
Answer is applied to the query
Query status changes to "answered_by_staff"
Batch Suggestions View:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Auto-Suggested Answers                          [Review All]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  We found 3 queries with potential answers from history:        â”‚
â”‚                                                                 â”‚
â”‚  âœ¨ Barclays Interest (Â£12.50) - 95% match                      â”‚
â”‚  âœ¨ Barclays Transfer (Â£500.00) - 92% match                     â”‚
â”‚  âœ¨ Amazon Web Services (Â£150.00) - 88% match                   â”‚
â”‚                                                                 â”‚
â”‚  [Review & Apply Suggestions]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Estimated Effort: 10-12 hours

5.5 Admin Settings Page
Location: Company Settings > Bookkeeping

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Query Answer Suggestions                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â˜‘ Enable auto-suggestions for bookkeeping queries              â”‚
â”‚                                                                 â”‚
â”‚  Matching Settings:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Minimum characters to match: [10 â–¼]                        â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚ The system will compare the first N characters of          â”‚â”‚
â”‚  â”‚ transaction descriptions to find similar past queries.     â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚ Options: 5, 8, 10, 15, 20 characters                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  Suggestion Scope:                                              â”‚
â”‚  â—‹ Same client only                                             â”‚
â”‚  â—‹ Same company only                                            â”‚
â”‚  â— Both (prefer same client, fallback to company)               â”‚
â”‚                                                                 â”‚
â”‚  â˜ Match money direction (in/out)                               â”‚
â”‚    Only suggest answers from queries with the same              â”‚
â”‚    transaction direction                                        â”‚
â”‚                                                                 â”‚
â”‚  [Save Settings]                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Estimated Effort: 4-6 hours

5.6 Total Estimated Effort for Stage 5
Component	Hours
Database schema	3-4
Matching algorithm	4-6
Backend API	6-8
Frontend UI	10-12
Admin settings	4-6
Testing & refinement	6-8
Total	33-44 hours
Stage 6: Notification Improvements (Priority: Medium)
5.1 Notify Assignees When Client Answers Queries
Feature: Option during query scheduling to notify project assignees when the client submits responses.

Implementation:

Database Changes: Add column to query_response_tokens:

ALTER TABLE query_response_tokens 
ADD COLUMN notify_on_response_user_ids TEXT[] DEFAULT '{}';

UI Changes (Send to Client Flow): Add step in scheduling dialog:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Notify when client responds?                                   â”‚
â”‚                                                                 â”‚
â”‚  â˜‘ Sarah Johnson (Client Manager)                               â”‚
â”‚  â˜‘ Mike Smith (Bookkeeper)                                      â”‚
â”‚  â˜ Admin User                                                   â”‚
â”‚                                                                 â”‚
â”‚  These people will receive an email notification as soon as     â”‚
â”‚  the client submits their responses.                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Backend Trigger: In the client response submission endpoint (POST /api/query-response/:token):

// After saving responses...
if (token.notifyOnResponseUserIds?.length > 0) {
  for (const userId of token.notifyOnResponseUserIds) {
    await sendQueryAnsweredNotification(userId, token, project);
  }
}

Notification Content:

Email subject: "Client Responded: [Project Name] Queries"
Email body: Summary of responses + link to project
Estimated Effort: 6-8 hours

5.2 Improve Notify Assignees Dialog
Current Issues:

No loading state while fetching assignees
No empty state message
Doesn't show which assignees were already notified
Improvements:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Notify Assignees                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Loading assignees...  [Spinner]                                â”‚
â”‚                                                                 â”‚
â”‚  OR                                                             â”‚
â”‚                                                                 â”‚
â”‚  Select team members to notify:                                 â”‚
â”‚  â˜ Sarah Johnson (Client Manager)                               â”‚
â”‚  â˜ Mike Smith (Bookkeeper)                                      â”‚
â”‚                                                                 â”‚
â”‚  Custom Message:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Please review the client's query responses.                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  [Cancel]                              [Send Notifications]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Estimated Effort: 2-3 hours

Stage 6: UI/UX Enhancements (Priority: Low)
6.1 Larger Kanban Modal
Current State: The Messages modal is 80vw x 80vh which may feel cramped for the Queries tab with all its functionality.

Proposed Changes:

Increase modal size when Queries tab is active:
Width: 90vw (max 1400px)
Height: 85vh
Add responsive breakpoints for smaller screens
Ensure scrollable areas work correctly
Estimated Effort: 2-3 hours

6.2 Show Grouped Query Indicator in Table
Visual indicator for grouped queries:

â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜ â”‚ Date     â”‚ Description            â”‚ Amount   â”‚ Group â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜ â”‚ 15 Nov   â”‚ Barclays Bank Interest â”‚ Â£12.50   â”‚ ğŸ“¦ B  â”‚
â”‚ â˜ â”‚ 18 Nov   â”‚ Barclays Bank Fee      â”‚ Â£15.00   â”‚ ğŸ“¦ B  â”‚
â”‚ â˜ â”‚ 22 Nov   â”‚ Amazon Prime           â”‚ Â£9.99    â”‚ ğŸ“¦ A  â”‚
â”‚ â˜ â”‚ 25 Nov   â”‚ Office Supplies        â”‚ Â£45.00   â”‚  -    â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
Legend: ğŸ“¦ B = Barclays group, ğŸ“¦ A = Amazon group

Estimated Effort: 2-3 hours

Implementation Timeline
Stage	Description	Priority	Estimated Hours	Week
1.1	Fix Notify button	Critical	2-4	Week 1
1.2	Fix Cancel All in Kanban	Critical	2-4	Week 1
2.1	Description search filter	High	3-4	Week 1
2.2	Money In/Out filter	High	1-2	Week 1
3.1	Database schema for groups	High	2-3	Week 2
3.2	Manual grouping feature	High	8-10	Week 2
3.3	Grouped client view	High	10-12	Week 3
3.4	Edit/remove from groups	High	6-8	Week 3
4.1	Auto-group algorithm	Medium	6-8	Week 4
4.2	Auto-group UI	Medium	8-10	Week 4
5.1	Notify on client response	Medium	6-8	Week 5
5.2	Improve notify dialog	Medium	2-3	Week 5
6.1	Larger Kanban modal	Low	2-3	Week 5
6.2	Group indicator in table	Low	2-3	Week 5
Total Estimated Effort: 62-82 hours (approximately 2-3 weeks of focused development)

Technical Dependencies
Database Migration: Required for Stage 3 (query groups)
Object Storage: Already configured for attachments
Email Service: Already configured (SendGrid)
Notification System: Existing infrastructure can be extended
Testing Considerations
Unit Tests
Auto-group algorithm edge cases
Group CRUD operations
Filter logic
Integration Tests
End-to-end grouping flow
Client response for grouped queries
Notification delivery
Manual Testing Scenarios
Create group, send to client, client responds
Auto-group suggestions with various data patterns
Remove queries from group, re-add
Cancel all reminders from Kanban modal
Notify assignees button with various project configurations
Rollback Plan
Each stage is designed to be independently deployable. If issues arise:

Database changes: Migrations can be reverted (groupId column allows NULL)
UI changes: Feature flags can disable new functionality
Algorithm changes: Auto-group is optional, manual grouping remains available
Success Metrics
Reduction in queries sent to client: Grouped queries should reduce the number of individual items clients need to respond to
Staff efficiency: Time to create and manage query groups
Client response rate: Monitor if grouped queries improve response rates
Bug fix validation: Notify button and Cancel All button work consistently
Open Questions
Should grouped queries share a single VAT toggle or maintain individual toggles?
Should auto-group run automatically when importing bulk queries?
Should there be a maximum number of queries per group?
Should clients be able to respond to individual queries within a group, or only to the group as a whole?
Appendix: File Changes Required
New Files
shared/schema/queries/groups.ts - Query groups schema
server/storage/queries/queryGroupStorage.ts - Group storage operations
client/src/components/queries/QueryGroupDialog.tsx - Create/edit group UI
client/src/components/queries/AutoGroupReview.tsx - Auto-group review UI
client/src/components/queries/ManageGroupsPanel.tsx - Groups management
Modified Files
shared/schema/queries/tables.ts - Add queryGroups table, groupId column
server/routes/queries.ts - Add group-related endpoints
client/src/components/queries/QueriesTab.tsx - Add filters, grouping UI
client/src/pages/query-response.tsx - Handle grouped queries
client/src/components/queries/ScheduledRemindersPanel.tsx - Fix cancel button
client/src/components/messages-modal.tsx - Increase modal size
Client-Specific Stage Approval Forms - Implementation Plan
Executive Summary
This document outlines the implementation of client-specific stage approval forms, allowing individual clients to have custom approval requirements while maintaining analytical consistency through a shared field library.

Approach: Binary override (client uses standard OR custom approval) with a reusable field library for consistency and analysis.

Includes: Expansion of available field types from 4 to 7 for greater flexibility.

Current Architecture
How Stage Approvals Work Today
projectTypes
    â””â”€â”€ stageApprovals (defined per project type)
            â””â”€â”€ stageApprovalFields (questions/validations)
                    â””â”€â”€ stageApprovalResponses (answers per project)
kanbanStages
    â””â”€â”€ stageApprovalId â†’ stageApprovals.id (which approval to show)

Key tables:

stageApprovals - Approval form definitions, scoped to project type
stageApprovalFields - Individual fields (boolean, number, text, multi_select) with validation rules
stageApprovalResponses - Responses stored per project/field
kanbanStages - Links stages to approvals via stageApprovalId
Limitation: All clients using the same project type see identical approval forms.

Field Type Expansion
Current Field Types (4)
Type	Purpose	Validation
boolean	Yes/No confirmation	Must match expected value
number	Numeric entry	Comparison (=, <, >) against expected
long_text	Free-form notes	Required check only
multi_select	Multiple checkbox options	Options validation
New Field Types (3 additions)
Type	Purpose	Validation	Use Cases
short_text	Single-line text	Required check, optional max length	Supplier name, invoice reference, account code
single_select	Pick ONE from list	Must be one of defined options	Bank account reconciled, payment method used
date	Date picker	Required, optional before/after/between	Date payroll processed, bank statement date
Updated Enum
// BEFORE
stageApprovalFieldTypeEnum = ["boolean", "number", "long_text", "multi_select"]
// AFTER
stageApprovalFieldTypeEnum = [
  "boolean",        // Yes/No with expected value
  "number",         // Numeric with comparison
  "short_text",     // Single line text (NEW)
  "long_text",      // Multi-line text
  "single_select",  // Pick one from list (NEW)
  "multi_select",   // Pick multiple from list
  "date"            // Date picker (NEW)
]

Response Storage for New Types
The stage_approval_responses table needs new columns:

ALTER TABLE stage_approval_responses
ADD COLUMN value_short_text VARCHAR(255),
ADD COLUMN value_single_select VARCHAR,
ADD COLUMN value_date TIMESTAMP;

Update the check constraint to allow exactly one value column populated:

ALTER TABLE stage_approval_responses
DROP CONSTRAINT check_single_value_populated;
ALTER TABLE stage_approval_responses
ADD CONSTRAINT check_single_value_populated CHECK (
  (value_boolean IS NOT NULL)::int +
  (value_number IS NOT NULL)::int +
  (value_short_text IS NOT NULL)::int +
  (value_long_text IS NOT NULL)::int +
  (value_single_select IS NOT NULL)::int +
  (value_multi_select IS NOT NULL)::int +
  (value_date IS NOT NULL)::int = 1
);

Validation Rules for New Types
Type	Schema Column	Validation Options
short_text	value_short_text	Required only, max 255 chars
single_select	value_single_select	Must be one of options[], required check
date	value_date	Required, optional: date_comparison_type (before/after/between) with expected_date / expected_date_end
New Schema Columns for Date Validation
ALTER TABLE stage_approval_fields
ADD COLUMN date_comparison_type VARCHAR CHECK (date_comparison_type IN ('before', 'after', 'between', 'exact')),
ADD COLUMN expected_date TIMESTAMP,
ADD COLUMN expected_date_end TIMESTAMP;
-- Validation: date fields should have date comparison if validation needed
ALTER TABLE stage_approval_fields
ADD CONSTRAINT check_date_field_validation CHECK (
  field_type != 'date' OR (
    date_comparison_type IS NULL OR 
    (date_comparison_type IN ('before', 'after', 'exact') AND expected_date IS NOT NULL) OR
    (date_comparison_type = 'between' AND expected_date IS NOT NULL AND expected_date_end IS NOT NULL)
  )
);

Frontend Component Updates
The StageApprovalForm.tsx component needs new field renderers:

// short_text
{field.fieldType === "short_text" && (
  <FormControl>
    <Input
      {...formField}
      maxLength={255}
      placeholder={field.placeholder || ""}
      data-testid={`input-approval-${field.id}`}
    />
  </FormControl>
)}
// single_select
{field.fieldType === "single_select" && field.options && (
  <FormControl>
    <Select onValueChange={formField.onChange} value={formField.value}>
      <SelectTrigger data-testid={`select-approval-${field.id}`}>
        <SelectValue placeholder={field.placeholder || "Select an option"} />
      </SelectTrigger>
      <SelectContent>
        {field.options.map((option: string) => (
          <SelectItem key={option} value={option}>
            {option}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  </FormControl>
)}
// date
{field.fieldType === "date" && (
  <FormControl>
    <DatePicker
      date={formField.value}
      onSelect={formField.onChange}
      data-testid={`date-approval-${field.id}`}
    />
  </FormControl>
)}

Proposed Architecture
New Concept: Field Library + Client Overrides
approvalFieldLibrary (NEW)
    â””â”€â”€ Reusable field definitions per project type
    
stageApprovalFields (MODIFIED)
    â””â”€â”€ Can reference libraryFieldId OR define custom field
clientStageApprovalOverrides (NEW)
    â””â”€â”€ Maps client + stage to a custom approval

How It Will Work
Library fields are defined once per project type (e.g., "Payroll journals added?")
Standard approvals reference library fields
Custom client approvals can:
Pick fields from the same library (enabling cross-client analysis)
Add truly unique fields (null libraryFieldId)
Runtime: Check if client has override â†’ use that approval, else use standard
Analysis: Group responses by libraryFieldId regardless of which approval they came from
Database Schema Changes
Stage 1: Expand Field Types
1.0 Update Field Type Enum
-- Add new values to the enum
ALTER TYPE stage_approval_field_type ADD VALUE 'short_text';
ALTER TYPE stage_approval_field_type ADD VALUE 'single_select';
ALTER TYPE stage_approval_field_type ADD VALUE 'date';

1.0a Add Response Columns
ALTER TABLE stage_approval_responses
ADD COLUMN value_short_text VARCHAR(255),
ADD COLUMN value_single_select VARCHAR,
ADD COLUMN value_date TIMESTAMP;
-- Update check constraint
ALTER TABLE stage_approval_responses
DROP CONSTRAINT check_single_value_populated;
ALTER TABLE stage_approval_responses
ADD CONSTRAINT check_single_value_populated CHECK (
  (value_boolean IS NOT NULL)::int +
  (value_number IS NOT NULL)::int +
  (value_short_text IS NOT NULL)::int +
  (value_long_text IS NOT NULL)::int +
  (value_single_select IS NOT NULL)::int +
  (value_multi_select IS NOT NULL)::int +
  (value_date IS NOT NULL)::int = 1
);

1.0b Add Date Validation Columns
ALTER TABLE stage_approval_fields
ADD COLUMN date_comparison_type VARCHAR,
ADD COLUMN expected_date TIMESTAMP,
ADD COLUMN expected_date_end TIMESTAMP;
ALTER TABLE stage_approval_fields
ADD CONSTRAINT check_date_comparison_type CHECK (
  date_comparison_type IS NULL OR date_comparison_type IN ('before', 'after', 'between', 'exact')
);
ALTER TABLE stage_approval_fields
ADD CONSTRAINT check_date_field_validation CHECK (
  field_type != 'date' OR (
    date_comparison_type IS NULL OR 
    (date_comparison_type IN ('before', 'after', 'exact') AND expected_date IS NOT NULL) OR
    (date_comparison_type = 'between' AND expected_date IS NOT NULL AND expected_date_end IS NOT NULL)
  )
);

Stage 1: New Tables
1.1 Approval Field Library
CREATE TABLE approval_field_library (
  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
  project_type_id VARCHAR NOT NULL REFERENCES project_types(id) ON DELETE CASCADE,
  field_name VARCHAR NOT NULL,
  field_type stage_approval_field_type_enum NOT NULL,
  description TEXT,
  placeholder VARCHAR,
  -- Boolean validation
  expected_value_boolean BOOLEAN,
  -- Number validation
  comparison_type comparison_type_enum,
  expected_value_number INTEGER,
  -- Date validation (NEW)
  date_comparison_type VARCHAR,
  expected_date TIMESTAMP,
  expected_date_end TIMESTAMP,
  -- Select options
  options TEXT[],
  -- Library metadata
  is_commonly_required BOOLEAN DEFAULT false,
  usage_hint TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  
  CONSTRAINT unique_library_field_name_per_type UNIQUE (project_type_id, field_name),
  CONSTRAINT check_date_comparison_type CHECK (
    date_comparison_type IS NULL OR date_comparison_type IN ('before', 'after', 'between', 'exact')
  )
);
CREATE INDEX idx_approval_field_library_project_type ON approval_field_library(project_type_id);
CREATE INDEX idx_approval_field_library_field_type ON approval_field_library(field_type);

Field descriptions:

Column	Purpose
field_name	Display name (e.g., "Payroll journals added?")
field_type	boolean, number, short_text, long_text, single_select, multi_select, date
description	Help text shown to users
expected_value_*	Validation criteria for boolean/number
date_comparison_type	Validation type for dates (before/after/between/exact)
expected_date / expected_date_end	Date validation boundaries
options	Choices for single_select and multi_select
is_commonly_required	Hint for UI - suggests this field is typically required
usage_hint	Admin guidance (e.g., "Use for clients with payroll services")
1.2 Client Stage Approval Overrides
CREATE TABLE client_stage_approval_overrides (
  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id VARCHAR NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  project_type_id VARCHAR NOT NULL REFERENCES project_types(id) ON DELETE CASCADE,
  stage_id VARCHAR NOT NULL REFERENCES kanban_stages(id) ON DELETE CASCADE,
  override_approval_id VARCHAR NOT NULL REFERENCES stage_approvals(id) ON DELETE CASCADE,
  notes TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  created_by_user_id VARCHAR REFERENCES users(id),
  
  CONSTRAINT unique_client_stage_override UNIQUE (client_id, project_type_id, stage_id)
);
CREATE INDEX idx_client_overrides_client ON client_stage_approval_overrides(client_id);
CREATE INDEX idx_client_overrides_project_type ON client_stage_approval_overrides(project_type_id);
CREATE INDEX idx_client_overrides_stage ON client_stage_approval_overrides(stage_id);

Stage 2: Modify Existing Table
2.1 Add Library Reference to Stage Approval Fields
ALTER TABLE stage_approval_fields 
ADD COLUMN library_field_id VARCHAR REFERENCES approval_field_library(id) ON DELETE SET NULL;
CREATE INDEX idx_stage_approval_fields_library ON stage_approval_fields(library_field_id);

Behavior:

If library_field_id is set â†’ field inherits definition from library (field_name, field_type, description, validation rules)
If library_field_id is null â†’ field uses its own column values (existing behavior)
is_required and order are ALWAYS per-approval (not inherited)
Backend Implementation
Stage 3: Storage Layer
3.0 Update Validation Logic
Modify projectApprovalsStorage.ts â†’ validateStageApprovalResponses to handle new types:

// Add validation for new field types
} else if (field.fieldType === 'short_text') {
  // Short text: just check required and length
  if (field.isRequired && (!response.valueShortText || response.valueShortText.trim() === '')) {
    failedFields.push(field.fieldName);
  }
  if (response.valueShortText && response.valueShortText.length > 255) {
    failedFields.push(`${field.fieldName}: exceeds 255 character limit`);
  }
} else if (field.fieldType === 'single_select') {
  // Single select: must be one of options
  if (field.isRequired && !response.valueSingleSelect) {
    failedFields.push(field.fieldName);
  }
  if (response.valueSingleSelect && field.options && !field.options.includes(response.valueSingleSelect)) {
    failedFields.push(`${field.fieldName}: invalid option selected`);
  }
} else if (field.fieldType === 'date') {
  // Date: check required and optional date comparison
  if (field.isRequired && !response.valueDate) {
    failedFields.push(field.fieldName);
  }
  if (response.valueDate && field.dateComparisonType && field.expectedDate) {
    const responseDate = new Date(response.valueDate);
    const expectedDate = new Date(field.expectedDate);
    let isValid = true;
    
    switch (field.dateComparisonType) {
      case 'before':
        isValid = responseDate < expectedDate;
        break;
      case 'after':
        isValid = responseDate > expectedDate;
        break;
      case 'exact':
        isValid = responseDate.toDateString() === expectedDate.toDateString();
        break;
      case 'between':
        const endDate = new Date(field.expectedDateEnd!);
        isValid = responseDate >= expectedDate && responseDate <= endDate;
        break;
    }
    
    if (!isValid) {
      failedFields.push(field.fieldName);
    }
  }
}

3.1 New File: server/storage/projects/approvalFieldLibraryStorage.ts
export class ApprovalFieldLibraryStorage extends BaseStorage {
  
  // Get all library fields for a project type
  async getLibraryFieldsByProjectType(projectTypeId: string): Promise<ApprovalFieldLibraryItem[]>
  
  // Get a single library field
  async getLibraryFieldById(id: string): Promise<ApprovalFieldLibraryItem | undefined>
  
  // Create a new library field
  async createLibraryField(field: InsertApprovalFieldLibraryItem): Promise<ApprovalFieldLibraryItem>
  
  // Update a library field (propagates to all usages)
  async updateLibraryField(id: string, updates: Partial<InsertApprovalFieldLibraryItem>): Promise<ApprovalFieldLibraryItem>
  
  // Delete a library field (only if not in use)
  async deleteLibraryField(id: string): Promise<void>
  
  // Get usage count for a library field
  async getLibraryFieldUsageCount(id: string): Promise<number>
  
  // Get all approvals using a library field
  async getApprovalsUsingLibraryField(id: string): Promise<StageApproval[]>
}

3.2 New File: server/storage/projects/clientApprovalOverrideStorage.ts
export class ClientApprovalOverrideStorage extends BaseStorage {
  
  // Check if client has override for a stage
  async getClientOverride(
    clientId: string, 
    projectTypeId: string, 
    stageId: string
  ): Promise<ClientStageApprovalOverride | undefined>
  
  // Get all overrides for a client
  async getOverridesByClient(clientId: string): Promise<ClientStageApprovalOverrideWithDetails[]>
  
  // Get all overrides for a project type (admin view)
  async getOverridesByProjectType(projectTypeId: string): Promise<ClientStageApprovalOverrideWithDetails[]>
  
  // Create an override
  async createOverride(override: InsertClientStageApprovalOverride): Promise<ClientStageApprovalOverride>
  
  // Delete an override (revert to standard)
  async deleteOverride(id: string): Promise<void>
  
  // Batch check overrides for multiple stages (optimization)
  async getClientOverridesForProject(
    clientId: string, 
    projectTypeId: string
  ): Promise<Map<string, string>> // stageId â†’ overrideApprovalId
}

3.3 Modify: server/storage/projects/projectApprovalsStorage.ts
Add method to resolve fields with library inheritance:

async getResolvedApprovalFields(approvalId: string): Promise<ResolvedStageApprovalField[]> {
  // 1. Get all fields for approval
  // 2. For each field with libraryFieldId, merge library definition
  // 3. Return unified field list with inherited values resolved
}

Stage 4: Modify Stage Change Flow
4.1 Update: server/routes/projects/status.ts
In the stage change config endpoint (GET /api/projects/:id/stage-change-config):

// BEFORE: Get approval from stage
const stageApproval = stage.stageApprovalId 
  ? await storage.getStageApprovalById(stage.stageApprovalId)
  : null;
// AFTER: Check for client override first
const clientOverride = await storage.getClientOverride(
  project.clientId,
  project.projectTypeId,
  targetStageId
);
const effectiveApprovalId = clientOverride?.overrideApprovalId ?? stage.stageApprovalId;
const stageApproval = effectiveApprovalId
  ? await storage.getStageApprovalById(effectiveApprovalId)
  : null;
// Get resolved fields (with library inheritance)
const approvalFields = stageApproval
  ? await storage.getResolvedApprovalFields(stageApproval.id)
  : [];

Impact: +1 query to check for override. Minimal performance impact.

API Routes
Stage 5: New Endpoints
5.1 Library Field Management
GET    /api/project-types/:id/approval-field-library
POST   /api/project-types/:id/approval-field-library
PATCH  /api/approval-field-library/:id
DELETE /api/approval-field-library/:id
GET    /api/approval-field-library/:id/usage

5.2 Client Override Management
GET    /api/clients/:id/approval-overrides
POST   /api/clients/:id/approval-overrides
DELETE /api/clients/:id/approval-overrides/:overrideId
GET    /api/project-types/:id/client-overrides  (admin view: which clients have overrides)

5.3 Enhanced Approval Field Endpoints
POST   /api/stage-approvals/:id/fields/from-library
       Body: { libraryFieldId, order, isRequired }
       (Creates field referencing library item)

Frontend Implementation
Stage 6: Update Stage Approval Form for New Field Types
6.0 Modify: client/src/components/change-status/StageApprovalForm.tsx
Add renderers for new field types:

// Add imports
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { DatePicker } from "@/components/ui/date-picker"; // or Popover + Calendar
// In the render, add cases for new types:
{field.fieldType === "short_text" && (
  <div className="space-y-3">
    <FormControl>
      <Input
        {...formField}
        maxLength={255}
        placeholder={field.placeholder || "Enter text..."}
        data-testid={`input-short-text-approval-${field.id}`}
      />
    </FormControl>
    <FormMessage />
  </div>
)}
{field.fieldType === "single_select" && field.options && field.options.length > 0 && (
  <div className="space-y-3">
    <FormControl>
      <Select onValueChange={formField.onChange} value={formField.value || ""}>
        <SelectTrigger data-testid={`select-approval-${field.id}`}>
          <SelectValue placeholder={field.placeholder || "Select an option..."} />
        </SelectTrigger>
        <SelectContent>
          {field.options.map((option: string) => (
            <SelectItem key={option} value={option}>
              {option}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </FormControl>
    <FormMessage />
  </div>
)}
{field.fieldType === "date" && (
  <div className="space-y-3">
    {field.dateComparisonType && field.expectedDate && (
      <FormDescription className="flex items-center gap-2">
        <Calendar className="h-4 w-4" />
        Date must be {field.dateComparisonType}{" "}
        <strong>{format(new Date(field.expectedDate), "PP")}</strong>
        {field.dateComparisonType === "between" && field.expectedDateEnd && (
          <> and <strong>{format(new Date(field.expectedDateEnd), "PP")}</strong></>
        )}
      </FormDescription>
    )}
    <FormControl>
      <DatePicker
        date={formField.value}
        onSelect={formField.onChange}
        data-testid={`date-approval-${field.id}`}
      />
    </FormControl>
    <FormMessage />
  </div>
)}

Stage 6: Project Type Detail Page Updates
6.1 New Tab: "Field Library"
Location: client/src/pages/project-type-detail/components/tabs/FieldLibraryTab.tsx

Features:

List all library fields for project type
Create/edit/delete library fields
Support all 7 field types with appropriate config UI
Show usage count per field
Filter by field type
"Commonly required" toggle
6.2 Modify: "Stage Approvals" Tab
When adding fields to an approval:

New button: "Add from Library"
Opens modal showing available library fields
One-click add with order/required settings
Visual indicator for library-sourced vs custom fields
Stage 7: Client Detail Page Updates
7.1 New Tab: "Custom Approvals"
Location: client/src/pages/client-detail/components/tabs/CustomApprovalsTab.tsx

Features:

List stages with overrides for this client
"Add Override" button â†’ select project type â†’ select stage â†’ select/create approval
"Remove Override" â†’ revert to standard
Quick view of what fields are in custom vs standard
7.2 Override Creation Flow
1. Select project type (e.g., "Monthly Bookkeeping")
2. Select stage (e.g., "Review Complete")
3. Either:
   a. Select existing custom approval (if one exists)
   b. Create new approval:
      - Start blank OR copy from standard
      - Add fields from library / create custom
      - Save and assign as override

Stage 8: Stage Change Modal Updates
8.1 Modify: client/src/components/change-status/StageApprovalForm.tsx
Already covered in Stage 6.0 - new field type renderers.

8.2 Modify: client/src/hooks/change-status/useStageChangeConfig.ts
The hook already fetches config from the API. Backend changes handle returning the correct approval, so frontend automatically gets client-specific fields.

Optional enhancement: Show indicator "Custom approval for [Client Name]" in the modal.

8.3 Modify: client/src/hooks/change-status/useApprovalFormSchema.ts
Update schema generation to handle new field types:

// Add schema rules for new types
case 'short_text':
  schema[field.id] = field.isRequired
    ? z.string().min(1, "This field is required").max(255)
    : z.string().max(255).optional();
  break;
case 'single_select':
  schema[field.id] = field.isRequired
    ? z.string().min(1, "Please select an option")
    : z.string().optional();
  break;
case 'date':
  schema[field.id] = field.isRequired
    ? z.date({ required_error: "Please select a date" })
    : z.date().optional();
  break;

Analysis Capabilities
Stage 9: Reporting Queries
9.1 Cross-Client Field Analysis
-- Responses to a library field across all clients
SELECT 
  c.name as client_name,
  sa.name as approval_name,
  CASE 
    WHEN saf.library_field_id IS NOT NULL THEN 'Library'
    ELSE 'Custom'
  END as field_source,
  sar.value_boolean,
  sar.value_number,
  sar.value_short_text,
  sar.value_single_select,
  sar.value_date,
  COUNT(*) as response_count
FROM stage_approval_responses sar
JOIN stage_approval_fields saf ON sar.field_id = saf.id
JOIN projects p ON sar.project_id = p.id
JOIN clients c ON p.client_id = c.id
JOIN stage_approvals sa ON saf.stage_approval_id = sa.id
WHERE saf.library_field_id = :libraryFieldId
GROUP BY c.name, sa.name, field_source, 
  sar.value_boolean, sar.value_number, sar.value_short_text, 
  sar.value_single_select, sar.value_date
ORDER BY c.name;

9.2 Library Field Usage Report
-- Which library fields are most used?
SELECT 
  afl.field_name,
  afl.field_type,
  COUNT(DISTINCT saf.stage_approval_id) as approval_count,
  COUNT(DISTINCT sar.project_id) as project_response_count
FROM approval_field_library afl
LEFT JOIN stage_approval_fields saf ON saf.library_field_id = afl.id
LEFT JOIN stage_approval_responses sar ON sar.field_id = saf.id
WHERE afl.project_type_id = :projectTypeId
GROUP BY afl.id, afl.field_name, afl.field_type
ORDER BY approval_count DESC;

9.3 Clients with Custom Approvals
-- Which clients have overrides and for which stages?
SELECT 
  c.name as client_name,
  pt.name as project_type,
  ks.name as stage_name,
  sa.name as custom_approval_name,
  csao.created_at as override_created
FROM client_stage_approval_overrides csao
JOIN clients c ON csao.client_id = c.id
JOIN project_types pt ON csao.project_type_id = pt.id
JOIN kanban_stages ks ON csao.stage_id = ks.id
JOIN stage_approvals sa ON csao.override_approval_id = sa.id
ORDER BY c.name, pt.name, ks.order;

9.4 Field Type Distribution
-- What field types are most commonly used?
SELECT 
  field_type,
  COUNT(*) as library_count,
  COUNT(DISTINCT project_type_id) as project_types_using
FROM approval_field_library
GROUP BY field_type
ORDER BY library_count DESC;

Implementation Phases
Phase 1: Foundation (Day 1)
Tasks:

Create database migration:
Expand stage_approval_field_type enum with new values
Add new columns to stage_approval_fields (date validation)
Add new columns to stage_approval_responses (value_short_text, value_single_select, value_date)
Update check constraint for single value populated
Create approval_field_library table
Create client_stage_approval_overrides table
Add library_field_id column to stage_approval_fields
Create TypeScript types and Zod schemas for all new types
Create ApprovalFieldLibraryStorage class
Create ClientApprovalOverrideStorage class
Deliverable: Schema in place, basic storage methods working

Phase 2: Backend Integration (Day 2)
Tasks:

Update validation logic in projectApprovalsStorage.ts for new field types
Add API routes for library field management
Add API routes for client override management
Modify getResolvedApprovalFields to handle library inheritance
Modify stage change config endpoint to check for overrides
Add field creation from library endpoint
Deliverable: Full API available, stage changes respect client overrides

Phase 3: Frontend - New Field Types (Day 3)
Tasks:

Update StageApprovalForm.tsx with renderers for short_text, single_select, date
Update useApprovalFormSchema.ts for new field type validation
Update ApprovalFieldForm.tsx to allow creating/editing new field types
Test new field types work in stage change flow
Deliverable: New field types fully functional in existing approval flow

Phase 4: Admin UI - Field Library (Day 4)
Tasks:

Create FieldLibraryTab component
Add to project type detail page
Create/edit/delete library fields (all 7 types)
Show usage statistics
Deliverable: Admins can manage the field library

Phase 5: Admin UI - Approval Builder (Day 5)
Tasks:

Add "Add from Library" to approval field creation
Visual distinction for library vs custom fields
Copy-from-standard functionality for custom approvals
Deliverable: Approval creation leverages field library

Phase 6: Client Override UI (Day 6)
Tasks:

Create CustomApprovalsTab for client detail page
Override creation wizard
Override removal confirmation
Stage change modal indicator for custom approvals
Deliverable: Full client-specific approval management

Phase 7: Testing & Polish (Day 7)
Tasks:

End-to-end testing of all 7 field types
End-to-end testing of override flow
Test library field updates propagate correctly
Test analysis queries work as expected
Performance testing of stage change flow
Documentation updates
Deliverable: Production-ready feature

Risk Mitigation
Performance Risks
Risk	Mitigation
Extra query per stage change	Single indexed lookup, <5ms
Library field inheritance resolution	Eager join in single query
Many overrides to check	Batch fetch for project on modal open
Data Integrity Risks
Risk	Mitigation
Deleting library field in use	Prevent deletion, or set library_field_id to null (field becomes custom)
Updating library field	Changes propagate to all usages (feature, not bug)
Orphaned overrides	Cascade delete when stage/approval deleted
Invalid date comparisons	Database constraints prevent invalid config
User Experience Risks
Risk	Mitigation
Confusion about which approval applies	Clear indicator in stage change modal
Accidentally creating duplicate fields	Unique constraint on (project_type_id, field_name) in library
Complex admin UI	Guided wizards, copy-from-standard option
Date picker confusion	Show expected date range/comparison in description
Success Metrics
Adoption: Number of clients with custom overrides
Library utilization: % of approval fields sourced from library
Field type usage: Distribution of field types used (expect increase in single_select, date)
Analysis value: Reports generated using cross-client field data
Performance: Stage change time remains under 500ms
Admin efficiency: Time to create new client approval < 5 minutes
Open Questions
Permissions: Who can create/modify client overrides? Account managers? Only super admins?
Visibility: Should clients see that they have custom approvals in the portal?
History: Should we track when overrides are added/removed?
Bulk assignment: Should we support assigning the same custom approval to multiple clients?
Date defaults: Should date fields allow "today", "project due date", etc. as dynamic defaults?
Appendix A: Complete Type Definitions
// New types for shared/schema
// Field type enum (expanded)
export type StageApprovalFieldType = 
  | 'boolean' 
  | 'number' 
  | 'short_text' 
  | 'long_text' 
  | 'single_select' 
  | 'multi_select' 
  | 'date';
// Date comparison type
export type DateComparisonType = 'before' | 'after' | 'between' | 'exact';
// Library field definition
export interface ApprovalFieldLibraryItem {
  id: string;
  projectTypeId: string;
  fieldName: string;
  fieldType: StageApprovalFieldType;
  description: string | null;
  placeholder: string | null;
  // Boolean validation
  expectedValueBoolean: boolean | null;
  // Number validation
  comparisonType: 'equal_to' | 'less_than' | 'greater_than' | null;
  expectedValueNumber: number | null;
  // Date validation
  dateComparisonType: DateComparisonType | null;
  expectedDate: Date | null;
  expectedDateEnd: Date | null;
  // Select options
  options: string[] | null;
  // Library metadata
  isCommonlyRequired: boolean;
  usageHint: string | null;
  createdAt: Date;
}
// Client override
export interface ClientStageApprovalOverride {
  id: string;
  clientId: string;
  projectTypeId: string;
  stageId: string;
  overrideApprovalId: string;
  notes: string | null;
  createdAt: Date;
  createdByUserId: string | null;
}
// Resolved field (with library inheritance applied)
export interface ResolvedStageApprovalField {
  id: string;
  stageApprovalId: string;
  libraryFieldId: string | null;
  // Core field properties (from library if linked)
  fieldName: string;
  fieldType: StageApprovalFieldType;
  description: string | null;
  placeholder: string | null;
  // Validation (from library if linked)
  expectedValueBoolean: boolean | null;
  comparisonType: 'equal_to' | 'less_than' | 'greater_than' | null;
  expectedValueNumber: number | null;
  dateComparisonType: DateComparisonType | null;
  expectedDate: Date | null;
  expectedDateEnd: Date | null;
  options: string[] | null;
  // Per-approval settings (never inherited)
  isRequired: boolean;
  order: number;
  // Metadata
  isFromLibrary: boolean;
}
// Response with all value columns
export interface StageApprovalResponse {
  id: string;
  projectId: string;
  fieldId: string;
  valueBoolean: boolean | null;
  valueNumber: number | null;
  valueShortText: string | null;
  valueLongText: string | null;
  valueSingleSelect: string | null;
  valueMultiSelect: string[] | null;
  valueDate: Date | null;
  createdAt: Date;
}

Appendix B: Field Type Summary
Type	Response Column	Validation Options	UI Component
boolean	value_boolean	Expected value (true/false)	Switch
number	value_number	Comparison (=, <, >)	Input[type=number]
short_text	value_short_text	Required only, max 255	Input[type=text]
long_text	value_long_text	Required only	Textarea
single_select	value_single_select	Must be in options	Select dropdown
multi_select	value_multi_select	All must be in options	Checkbox group
date	value_date	Before/after/between/exact	DatePicker
Document created: December 2024 Last updated: December 2024 Status: Planning Complete - Ready for Implementation

Accounts Workflow Smoothing - Implementation Document
Quick Reference Summary
Purpose: Intelligently distribute annual accounts work across months to eliminate peaks and troughs.

Key Data Points:

Complexity weight: Stored on client_services mapping (0.5-2.0 scale, default 1.0)
Service owner: Defined per client-service in client_services.serviceOwnerId
Capacity target: staff_service_capacity.annualCapacity / 12 OR SUM(client_services.complexityWeight) / 12
Two-Phase Scheduling:

Provisional (project created) â†’ Best guess based on current capacity
Confirmed (docs received) â†’ Recalculated based on real-time capacity
Tolerance Zones:

Zone	Utilization	Behaviour
Green	0-100%	Auto-assign
Amber	100-120%	Auto-assign with warning
Red	120-150%	Human approval required
Critical	150%+	Escalate to management
Auto-Rebalancing: Before declaring capacity breached, system moves flexible work (60+ days slack) to make room.

Stage Triggers (Project Type Settings):

preWorkStageId â†’ Triggers provisional scheduling
readyQueueStageId â†’ Triggers confirmed scheduling
mainWorkStageId â†’ Triggers "in progress" status
Implementation MVP: ~15-20 days (Phases 1-3, 5-6 basic)

Overview
This feature provides intelligent workload distribution for annual accounts and similar periodic work. It addresses the common accounting practice problem of peaks and troughs in workload by analysing capacity and automatically suggesting optimal months for work completion.

Key Objectives
Smooth the distribution of annual accounts work across the year
Prevent overloading of staff in peak months
Automatically assign optimal target months when projects are created
Provide visibility into forward capacity planning
Core Concepts
The Three Dates
Every annual accounts project has three key dates:

Date	Description	Example
Year End	The client's accounting period end	31 December
Due Date	Statutory filing deadline	30 September (9 months on)
Target Date	Internal target for completion	31 May (5 months on)
The Flexible Window
The period between the earliest practical start and the due date represents the flexible window where work can be scheduled:

Year End â”€â”€â”€â”€â”€â”€â”€ Earliest Start â•â•â•â•â•â•â•â•â•â•â• Target â•â•â•â•â•â•â•â•â•â•â• Due Date
   â”‚                   â”‚                       â”‚                   â”‚
Dec 31              Feb 1                   May 31             Sep 30
                      â””â”€â”€â”€â”€â”€â”€â”€ Flexible Window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Weighting System
Not all jobs are equal. A weight score (0.5 to 2.0) indicates relative complexity:

Weight	Description	Examples
0.5	Minimal work	Dormant company, very simple records
1.0	Standard	Typical small company, clean bookkeeping
1.5	Moderate complexity	Multiple revenue streams, some adjustments
2.0	High complexity	Groups, consolidations, complex transactions
Capacity Formula
For a service owner (the person responsible for delivering a service to clients):

Monthly Target = (Sum of complexity weights for owned services) / 12

Example:

Jane owns annual accounts for 24 clients
Total weight from client_services: 28.5 (mix of complexities)
Monthly target: 28.5 / 12 = 2.4 weighted units per month
This means months should aim for ~2.4 weighted units of work, not exactly 2.4 jobs.

Note: Only services with enableComplexityWeighting = TRUE count toward this target. VAT returns, payroll, etc. have fixed deadlines and are excluded from smoothing calculations.

Data Model Changes
New Fields on services Table
// Add to services table
enableComplexityWeighting: boolean("enable_complexity_weighting").default(false),
// TRUE for services that should be smoothed (annual accounts)
// FALSE for fixed-deadline services (VAT returns, payroll)

New Fields on client_services Table (Mapping)
// Add to client_services table (the client-service mapping)
serviceOwnerId: varchar("service_owner_id").references(() => users.id),
// Who owns THIS service for THIS client (may differ from client manager)
complexityWeight: decimal("complexity_weight", { precision: 3, scale: 2 }).default("1.00"),
// Range: 0.50 to 2.00
// Weight for THIS specific client-service combination
// Only relevant when service.enableComplexityWeighting = TRUE
// DEFAULT: 1.00 - used for legacy data or if not explicitly set

Default Complexity Weight Handling
Critical rule: If complexityWeight is null, undefined, or missing (legacy data, system glitch), always default to 1.00.

FUNCTION getComplexityWeight(clientServiceId):
    
    weight = clientService.complexityWeight
    
    IF weight IS NULL OR weight IS UNDEFINED:
        RETURN 1.00  // Safe default for legacy/missing data
    
    IF weight < 0.50:
        RETURN 0.50  // Minimum floor
    
    IF weight > 2.00:
        RETURN 2.00  // Maximum ceiling
    
    RETURN weight

This ensures:

Legacy data without complexity scores still works (treated as "standard" complexity)
System glitches don't break calculations
All capacity calculations have valid weights
Why at service level?

Same client might have simple accounts (0.5) but complex payroll (1.5)
Different staff may own different services for the same client
Only "smoothable" services (annual accounts) participate in capacity planning
New Fields on projects Table
// Add to projects table
// Schedule status: tracks where in the scheduling lifecycle
scheduleStatus: varchar("schedule_status"),
// Values: 'provisional' | 'confirmed' | 'in_progress' | 'completed' | 'delayed'
// Provisional scheduling (assigned at project creation)
provisionalScheduledMonth: varchar("provisional_scheduled_month"),
// Format: "YYYY-MM" - best guess based on capacity at creation time
// Confirmed scheduling (assigned when docs received)
confirmedScheduledMonth: varchar("confirmed_scheduled_month"),
// Format: "YYYY-MM" - actual month based on real-time capacity when docs arrive
suggestedStartDate: timestamp("suggested_start_date"),
// Calculated date when main work should begin (set on confirmation)
schedulingNotes: text("scheduling_notes"),
// Auto-generated notes explaining why this month was chosen
// Delay tracking
originalScheduledMonth: varchar("original_scheduled_month"),
// If rescheduled, stores the original month for reporting
delayReason: varchar("delay_reason"),
// If delayed: 'documents_late' | 'capacity_full' | 'client_request' | 'other'

New Table: capacity_targets
export const capacityTargets = pgTable("capacity_targets", {
  id: varchar("id").primaryKey(),
  userId: varchar("user_id").notNull().references(() => users.id),
  yearMonth: varchar("year_month").notNull(), // Format: "YYYY-MM"
  targetCapacity: decimal("target_capacity", { precision: 5, scale: 2 }),
  // Override for specific months (holidays, part-time, etc.)
  notes: text("notes"),
  createdAt: timestamp("created_at").defaultNow(),
}, (table) => [
  unique("unique_user_month").on(table.userId, table.yearMonth),
]);

New Table: smoothing_snapshots
For tracking and reporting on distribution over time:

export const smoothingSnapshots = pgTable("smoothing_snapshots", {
  id: varchar("id").primaryKey(),
  snapshotDate: timestamp("snapshot_date").notNull(),
  userId: varchar("user_id").references(() => users.id), // null = firm-wide
  yearMonth: varchar("year_month").notNull(),
  projectCount: integer("project_count").notNull(),
  totalWeight: decimal("total_weight", { precision: 6, scale: 2 }),
  targetCapacity: decimal("target_capacity", { precision: 5, scale: 2 }),
  utilizationPercent: decimal("utilization_percent", { precision: 5, scale: 2 }),
  createdAt: timestamp("created_at").defaultNow(),
});

The Two-Stage Pre-Work Flow
When an annual accounts project is created, it follows this lifecycle with two distinct pre-work stages:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PROJECT LIFECYCLE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Year End]                                                              â”‚
â”‚      â”‚                                                                   â”‚
â”‚      â–¼                                                                   â”‚
â”‚  PROJECT CREATED (day after year end)                                   â”‚
â”‚      â”‚                                                                   â”‚
â”‚      â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚  STAGE 1: GATHER DOCUMENTS             â”‚ â—„â”€â”€ Active chasing stage   â”‚
â”‚  â”‚  - Request bank statements             â”‚     No time pressure yet   â”‚
â”‚  â”‚  - Request invoices/receipts           â”‚     Client manager works   â”‚
â”‚  â”‚  - Chase outstanding items             â”‚     to collect everything  â”‚
â”‚  â”‚  - Verify bookkeeping complete         â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚      â”‚                                                                   â”‚
â”‚      â”‚ (Client manager confirms all docs received)                       â”‚
â”‚      â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚  STAGE 2: READY TO START               â”‚ â—„â”€â”€ Holding bay / queue    â”‚
â”‚  â”‚  - All documents received              â”‚     Waiting for scheduled  â”‚
â”‚  â”‚  - Work is queued                      â”‚     slot to open           â”‚
â”‚  â”‚  - Nightly job checks if slot ready    â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚      â”‚                                                                   â”‚
â”‚      â”‚ (Nightly scheduler: suggestedStartDate reached)                   â”‚
â”‚      â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚  MAIN WORK STAGES BEGIN                â”‚ â—„â”€â”€ Scheduled month starts â”‚
â”‚  â”‚  - Records review                      â”‚                             â”‚
â”‚  â”‚  - Draft accounts                      â”‚                             â”‚
â”‚  â”‚  - Manager review                      â”‚                             â”‚
â”‚  â”‚  - Client queries                      â”‚                             â”‚
â”‚  â”‚  - Finalisation                        â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚      â”‚                                                                   â”‚
â”‚      â–¼                                                                   â”‚
â”‚  [TARGET DATE] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [DUE DATE]                  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Key Distinction Between the Two Pre-Work Stages
Stage	Purpose	Trigger to Exit	Time Pressure
Gather Documents	Actively chase client for records	Client manager manually moves when complete	Low - depends on client responsiveness
Ready to Start	Queue waiting for scheduled slot	Nightly scheduler moves when date reached	None - system controlled
Stage Configuration for Smoothing
Annual accounts project types should have designated pre-work stages that the system recognises:

New fields on kanbanStages table:

smoothingStageType: varchar("smoothing_stage_type"),
// Values: 'gather_documents' | 'ready_to_start' | 'main_work' | null
// Identifies the stage's role in the smoothing workflow
isSchedulerControlled: boolean("is_scheduler_controlled").default(false),
// If true, projects exit this stage via the nightly scheduler, not manually

The Nightly Scheduling Process
A scheduled job runs each night (e.g., 2:00 AM) to manage work release:

NIGHTLY SCHEDULER JOB
1. FIND all projects WHERE:
   - Current stage has smoothingStageType = 'ready_to_start'
   - suggestedStartDate <= TODAY
   - NOT archived AND NOT inactive
2. FOR each project:
   a. GET the next stage (first 'main_work' stage)
   b. MOVE project to that stage
   c. NOTIFY the assigned user: "ABC Ltd accounts is ready to start"
   d. LOG the transition in project chronology
3. FIND projects at risk (still in 'gather_documents' but running late):
   - WHERE current stage has smoothingStageType = 'gather_documents'
   - AND suggestedStartDate is within 14 days
   - AND documents still outstanding
   
4. FOR each at-risk project:
   a. FLAG project with warning indicator
   b. NOTIFY client manager: "ABC Ltd docs still outstanding - scheduled start in 10 days"
5. FIND critical projects (approaching due date):
   - WHERE dueDate is within 30 days
   - AND project not yet in main work stages
   
6. FOR each critical project:
   a. ESCALATE to manager/partner
   b. SEND urgent notification

Scheduler Configuration
New table: scheduler_config

export const schedulerConfig = pgTable("scheduler_config", {
  id: varchar("id").primaryKey(),
  configKey: varchar("config_key").notNull().unique(),
  configValue: jsonb("config_value").notNull(),
  updatedAt: timestamp("updated_at").defaultNow(),
});
// Example config entries:
// { key: "scheduler_run_time", value: "02:00" }
// { key: "at_risk_warning_days", value: 14 }
// { key: "critical_escalation_days", value: 30 }

The Capacity Heatmap / Calendar View
The capacity calendar displays forward-looking scheduled work:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Work Pipeline - Jane Smith                                    2025      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  January          February          March            April              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2.5 â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2.0   â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2.4 â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 3.1â”‚    â”‚
â”‚ â”‚              â”‚ â”‚              â”‚ â”‚              â”‚ â”‚          âš   â”‚    â”‚
â”‚ â”‚ In Progress: â”‚ â”‚ In Progress: â”‚ â”‚ Scheduled:   â”‚ â”‚ Scheduled:   â”‚    â”‚
â”‚ â”‚ â€¢ ABC Ltd    â”‚ â”‚ â€¢ DEF Co     â”‚ â”‚ â€¢ GHI Ltd    â”‚ â”‚ â€¢ JKL Co     â”‚    â”‚
â”‚ â”‚ â€¢ MNO Ltd    â”‚ â”‚ â€¢ PQR Ltd    â”‚ â”‚ â€¢ STU Ltd    â”‚ â”‚ â€¢ VWX Ltd    â”‚    â”‚
â”‚ â”‚              â”‚ â”‚              â”‚ â”‚              â”‚ â”‚ â€¢ YZ Ltd     â”‚    â”‚
â”‚ â”‚ Ready:       â”‚ â”‚ Ready:       â”‚ â”‚ Ready:       â”‚ â”‚ â€¢ AAA Ltd    â”‚    â”‚
â”‚ â”‚ â€¢ STU Ltd    â”‚ â”‚ â€¢ GHI Ltd    â”‚ â”‚ â€¢ JKL Co     â”‚ â”‚              â”‚    â”‚
â”‚ â”‚              â”‚ â”‚              â”‚ â”‚ â€¢ VWX Ltd    â”‚ â”‚              â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚ Legend: In Progress = main work stages | Ready = in 'Ready to Start'   â”‚
â”‚         Target: 2.4/month | âš  = over 120% capacity                      â”‚
â”‚                                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Gathering Documents (not yet scheduled):                            â”‚ â”‚
â”‚ â”‚ â€¢ BBB Ltd (Year End: Dec 24) - awaiting bank statements            â”‚ â”‚
â”‚ â”‚ â€¢ CCC Ltd (Year End: Nov 24) - awaiting purchase invoices âš  LATE   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

This gives visibility into:

What's being worked on now (in main stages)
What's queued and when it will arrive (in Ready to Start)
What's still being chased (in Gather Documents)
What's at risk (late document collection)
The Smoothing Algorithm
Key Concept: Provisional vs Confirmed Scheduling
The scheduled month is not fixed at project creation. Instead:

Provisional Schedule: Assigned at project creation (best guess based on current capacity)
Confirmed Schedule: Recalculated when documents are received (based on real-time capacity)
This handles the reality that clients don't always send documents on time.

SCHEDULING LIFECYCLE:
Project Created â”€â”€â”€â”€â–º Provisional Schedule: April
                      (based on capacity at creation time)
                      
Waiting for docs...   April passes, docs still not received
                      
Docs finally arrive â”€â–º RECALCULATE optimal month
(now June)            â”€â–º Confirmed Schedule: July
                      (based on current capacity, July has most space)

On Project Creation (Provisional Schedule)
When an annual accounts project is created:

FUNCTION assignProvisionalMonth(project, clientManager):
    
    1. GET yearEnd from client
    2. CALCULATE dueDate (yearEnd + statutory period, e.g., 9 months)
    3. CALCULATE earliestStart (yearEnd + minimum prep time, e.g., 2 months)
    4. CALCULATE latestTarget (dueDate - safety buffer, e.g., 2 weeks)
    
    5. GET clientWeight from client.complexityWeight
    
    6. FOR each month in range(earliestStart, latestTarget):
        a. GET currentLoad = sum of CONFIRMED weights for this month
        b. GET provisionalLoad = sum of PROVISIONAL weights for this month
        c. GET targetCapacity = clientManager's target for this month
        d. CALCULATE utilizationIfAdded = (currentLoad + provisionalLoad + clientWeight) / targetCapacity
        e. STORE month with its utilization score
    
    7. SELECT month with lowest utilizationIfAdded
       (prioritise months closer to yearEnd if scores are equal)
    
    8. SET project.provisionalScheduledMonth = selectedMonth
    9. SET project.scheduleStatus = 'provisional'
    
    RETURN project

On Document Receipt (Confirmed Schedule)
When a project moves from "Gather Documents" to "Ready to Start":

FUNCTION confirmScheduledMonth(project, clientManager):
    
    1. GET today's date
    2. GET dueDate from project
    3. CALCULATE earliestStart = MAX(today, original earliestStart)
       // Can't schedule in the past!
    4. CALCULATE latestTarget (dueDate - safety buffer)
    
    5. GET clientWeight from client.complexityWeight
    
    6. FOR each month in range(earliestStart, latestTarget):
        a. GET confirmedLoad = sum of CONFIRMED weights only
        b. GET targetCapacity = clientManager's target for this month
        c. CALCULATE utilizationIfAdded = (confirmedLoad + clientWeight) / targetCapacity
        d. STORE month with its utilization score
    
    7. SELECT month with lowest utilizationIfAdded
       (prioritise earlier months if scores are equal - get it done sooner)
    
    8. SET project.confirmedScheduledMonth = selectedMonth
    9. SET project.scheduleStatus = 'confirmed'
    10. SET project.suggestedStartDate = start of selectedMonth
    
    RETURN project

Why This Works for Late Documents
Scenario: 5 clients all send documents in the same month (June) when they were scheduled for different months.

Client A: Provisional April â†’ Docs arrive June â†’ Confirmed June (first in queue)
Client B: Provisional March â†’ Docs arrive June â†’ Confirmed June (still space)
Client C: Provisional May â†’ Docs arrive June â†’ Confirmed July (June now full)
Client D: Provisional April â†’ Docs arrive June â†’ Confirmed July (joins queue)
Client E: Provisional May â†’ Docs arrive June â†’ Confirmed August (July filling up)

Each client gets slotted into the next available capacity at the moment their documents arrive. The system automatically spreads the work.

Capacity Calculation (Dual View)
FUNCTION calculateMonthlyCapacity(userId, yearMonth):
    
    1. GET all active projects WHERE:
       - clientManagerId = userId OR projectOwnerId = userId
       - NOT archived AND NOT inactive
    
    2. SEPARATE into:
       a. CONFIRMED: scheduleStatus = 'confirmed' AND confirmedScheduledMonth = yearMonth
       b. PROVISIONAL: scheduleStatus = 'provisional' AND provisionalScheduledMonth = yearMonth
    
    3. CALCULATE:
       - confirmedWeight = sum of weights for confirmed projects
       - provisionalWeight = sum of weights for provisional projects
       - totalWeight = confirmedWeight + provisionalWeight
    
    4. GET targetCapacity for this user/month (or use default)
    
    5. RETURN {
         confirmedCount: count of confirmed projects,
         confirmedWeight: sum of confirmed weights,
         provisionalCount: count of provisional projects,
         provisionalWeight: sum of provisional weights,
         totalWeight: confirmedWeight + provisionalWeight,
         targetCapacity: from capacityTargets or calculated default,
         confirmedUtilization: (confirmedWeight / targetCapacity) * 100,
         totalUtilization: (totalWeight / targetCapacity) * 100
       }

Dashboard Display: Confirmed vs Provisional
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capacity View - Jane Smith                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚ April 2025                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚ 2.5 confirmed + 1.5 provisional = 4.0 total â”‚ â”‚
â”‚ â”‚ â–² confirmed  â–² provisional                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ Target: 2.4 â”‚ Confirmed: 104% âœ“ â”‚ If all provisional arrive: 167% âš    â”‚
â”‚                                                                          â”‚
â”‚ Confirmed work (docs received):                                         â”‚
â”‚ â€¢ ABC Ltd (1.5) - in Ready to Start queue                              â”‚
â”‚ â€¢ DEF Ltd (1.0) - in Ready to Start queue                              â”‚
â”‚                                                                          â”‚
â”‚ Provisional (awaiting docs - may slip):                                 â”‚
â”‚ â€¢ GHI Ltd (1.0) - docs requested 3 weeks ago                           â”‚
â”‚ â€¢ JKL Ltd (0.5) - docs requested 1 week ago                            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

This tells the client manager:

Confirmed work: This IS coming in April - plan for it
Provisional work: This MIGHT come in April, or might slip to later months
Realistic planning: Focus on confirmed utilization, treat provisional as "possible upside"
Staff Capacity Settings
Each service owner can have their capacity explicitly set, overriding the default calculation.

// New table: staff_service_capacity
export const staffServiceCapacity = pgTable("staff_service_capacity", {
  id: varchar("id").primaryKey(),
  userId: varchar("user_id").notNull().references(() => users.id),
  serviceId: varchar("service_id").notNull().references(() => services.id),
  
  // Capacity can be set as annual OR monthly (system converts as needed)
  annualCapacity: decimal("annual_capacity", { precision: 5, scale: 2 }),
  // Total weighted units this person can handle per year for this service
  
  monthlyCapacity: decimal("monthly_capacity", { precision: 4, scale: 2 }),
  // Alternative: set monthly directly (annualCapacity / 12 if not set)
  
  capacityNotes: text("capacity_notes"),
  // Optional explanation: "Part-time", "Also handles X", etc.
  
  updatedAt: timestamp("updated_at").defaultNow(),
  updatedBy: varchar("updated_by").references(() => users.id),
});

Example: Same clients, different capacity

Staff Member	Owned Weight	Capacity Setting	Monthly Target	Why
Mrs Experienced	28.5	Annual: 36.0	3.0/month	Fast, efficient
Mr No Experience	28.5	Annual: 24.0	2.0/month	Still learning
Ms Average	28.5	(not set)	2.375/month	Default: 28.5/12
Capacity Calculation Logic
FUNCTION getMonthlyCapacity(userId, serviceId):
    
    1. CHECK staff_service_capacity for explicit setting
       IF monthlyCapacity set: RETURN monthlyCapacity
       IF annualCapacity set: RETURN annualCapacity / 12
    
    2. IF no explicit setting, calculate default:
       a. GET all client_services 
          WHERE serviceOwnerId = userId
          AND serviceId = serviceId
          AND client.status = 'active'
       b. SUM all client_services.complexityWeight
       c. RETURN sum / 12

Example calculation:

Jane's capacity for "Annual Accounts" service:
Option A - Explicit setting exists:
â”œâ”€â”€ staff_service_capacity.annualCapacity = 36.0
â””â”€â”€ Monthly target: 36.0 / 12 = 3.0 weighted units
Option B - No explicit setting (default):
â”œâ”€â”€ Owned client_services total weight: 28.5
â””â”€â”€ Monthly target: 28.5 / 12 = 2.375 weighted units

Capacity Settings UI
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Staff Capacity Settings                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚ Staff Member: [Jane Smith â–¼]                                        â”‚
â”‚ Service: [Annual Accounts â–¼]                                        â”‚
â”‚                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Current workload (owned clients):                               â”‚ â”‚
â”‚ â”‚ 24 clients, total weight: 28.5                                  â”‚ â”‚
â”‚ â”‚ Default monthly target: 2.375 units                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚ Capacity override:                                                   â”‚
â”‚ â—‹ Use default (weight / 12)                                         â”‚
â”‚ â— Set explicitly:                                                    â”‚
â”‚                                                                      â”‚
â”‚   Annual capacity: [36.0] units/year                                â”‚
â”‚   OR                                                                 â”‚
â”‚   Monthly capacity: [3.0] units/month                               â”‚
â”‚                                                                      â”‚
â”‚ Notes: [Experienced, handles complex work efficiently_____]         â”‚
â”‚                                                                      â”‚
â”‚ [Save] [Cancel]                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Capacity Tolerance Zones
When capacity is exceeded, the system uses tolerance zones to determine whether to auto-assign or require human input.

Tolerance Thresholds
Zone	Utilization	System Behaviour
Green	0-100%	Auto-assign, no warnings
Amber	100-120%	Auto-assign with warning flag
Red	120-150%	Requires human approval to proceed
Critical	150%+	System refuses - escalates to management
How Assignment Works With Auto-Rebalancing
Before declaring capacity breached, the system first tries to automatically move flexible work to make room.

FUNCTION assignWithAutoRebalance(newProject, clientManager, targetMonth):
    
    1. CALCULATE utilizationIfAssigned for targetMonth
    
    2. IF utilization <= amber_threshold (120%):
       â†’ ASSIGN directly (Green/Amber zone)
       â†’ RETURN success
    
    3. IF utilization > amber_threshold:
       â†’ TRY to make room by moving flexible work
       
    4. FIND "moveable" projects in targetMonth:
       - scheduleStatus = 'confirmed'
       - daysUntilDueDate > 60 (plenty of slack)
       - NOT flagged as "priority" or "schedulingLocked"
       - hasNotBeenMovedRecently (no ping-pong)
       - SORT by most slack time first (move least urgent first)
    
    5. FOR each moveable project (max 3 moves per rebalance):
       a. FIND alternative months with capacity < 100%
       b. IF alternative found within their flexible window:
          â†’ MOVE project to alternative month
          â†’ SET project.lastAutoMovedAt = now
          â†’ RECALCULATE targetMonth utilization
          â†’ IF now <= amber_threshold: STOP moving
    
    6. AFTER rebalancing attempt:
       a. IF utilization <= amber_threshold:
          â†’ ASSIGN new project
          â†’ LOG all moves made
          â†’ NOTIFY affected staff: "XYZ Ltd moved from June to August"
          â†’ RETURN success
       b. IF still > amber_threshold:
          â†’ No more moveable work available
          â†’ FALL THROUGH to human approval (Red zone)
    
    7. IF no Green/Amber option available (even after rebalancing):
        a. FIND lowest Red zone option (120-150%)
        b. PAUSE assignment
        c. PRESENT options to client manager:
           â”œâ”€â”€ [Approve assignment to {month}] - will exceed by X%
           â”œâ”€â”€ [Request deadline extension from client]
           â”œâ”€â”€ [Reassign to different staff member]
           â””â”€â”€ [Escalate to partner for resource review]
        d. AWAIT human decision
    
    8. IF all options exceed 150% (Critical):
        a. REFUSE automatic assignment
        b. ESCALATE to partner/management immediately
        c. FLAG as "Resource Crisis - requires intervention"

Which Projects Can Be Auto-Moved?
Criteria	Moveable?	Reason
Due date 90+ days away	Yes	Plenty of slack
Due date 60-90 days away	Yes, if needed	Some slack available
Due date <60 days away	No	Too close to deadline
Flagged as "priority"	No	Client expectation set
Flagged as "scheduling locked"	No	Explicitly fixed
Moved in last 30 days	No	Avoid ping-ponging
Auto-Rebalance Example
SCENARIO: ABC Ltd docs arrive, needs scheduling for June
Current June: 2.8 / 2.4 (117% - Amber)
If ABC Ltd (1.0) added: 3.8 / 2.4 (158% - Critical!)
Step 1: Find moveable projects in June
â”œâ”€â”€ XYZ Ltd (1.0) - Due: July 30 - only 6 weeks slack - NOT MOVEABLE
â”œâ”€â”€ DEF Ltd (1.0) - Due: October 31 - 4 months slack - MOVEABLE âœ“
â””â”€â”€ GHI Ltd (0.8) - Due: November 30 - 5 months slack - MOVEABLE âœ“
Step 2: Move DEF Ltd (most slack) to August
â”œâ”€â”€ August before: 1.7 / 2.4 (71%)
â”œâ”€â”€ August after: 2.7 / 2.4 (113% - Amber, acceptable)
â””â”€â”€ DEF Ltd successfully moved
Step 3: Recalculate June
â”œâ”€â”€ June after move: 1.8 / 2.4 (75% - Green!)
â””â”€â”€ Now under threshold - stop moving
Step 4: Assign ABC Ltd to June
â”œâ”€â”€ June final: 2.8 / 2.4 (117% - Amber âœ“)
â””â”€â”€ AUTO-ASSIGNED successfully
Notifications:
â”œâ”€â”€ To DEF Ltd assignee: "DEF Ltd rescheduled from June to August"
â”œâ”€â”€ To ABC Ltd assignee: "ABC Ltd scheduled for June"
â””â”€â”€ Both logged in project chronology

Safeguards Against Chaos
Maximum 3 moves per rebalance: Prevents cascading disruption
30-day cool-off: Projects can only be auto-moved once per month
Priority lock: Important clients can be flagged as "unmoveable"
Notification trail: All moves logged and staff notified immediately
Reject window: Staff can reject an auto-move within 24 hours if problematic
New Fields for Auto-Rebalancing
// Add to projects table
schedulingLocked: boolean("scheduling_locked").default(false),
// If true, project cannot be auto-moved by rebalancing
lastAutoMovedAt: timestamp("last_auto_moved_at"),
// Prevents ping-ponging - can't be moved again within 30 days
autoMoveCount: integer("auto_move_count").default(0),
// Tracks how many times this project has been auto-rescheduled

Approval Workflow for Red Zone
When human approval is required:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš  Capacity Approval Required                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚ ABC Ltd documents have been received and need scheduling.               â”‚
â”‚                                                                          â”‚
â”‚ Due date: 30 September 2025                                             â”‚
â”‚ Weight: 1.5 (Moderate complexity)                                       â”‚
â”‚                                                                          â”‚
â”‚ Available options:                                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ July 2025                                                           â”‚ â”‚
â”‚ â”‚ Current: 2.6 / 2.4 (108%)                                          â”‚ â”‚
â”‚ â”‚ After adding ABC Ltd: 4.1 / 2.4 (171%) â† CRITICAL                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ August 2025                                                         â”‚ â”‚
â”‚ â”‚ Current: 2.2 / 2.4 (92%)                                           â”‚ â”‚
â”‚ â”‚ After adding ABC Ltd: 3.7 / 2.4 (154%) â† CRITICAL                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ September 2025                                                      â”‚ â”‚
â”‚ â”‚ Current: 1.8 / 2.4 (75%)                                           â”‚ â”‚
â”‚ â”‚ After adding ABC Ltd: 3.3 / 2.4 (138%) â† RED (approval needed)     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚ [Approve September] [Request Extension] [Reassign Staff] [Escalate]    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dynamic Threshold Relaxation
As due date approaches, thresholds can automatically relax to prioritise deadline compliance:

Days to Due Date	Amber Threshold	Red Threshold	Critical
90+ days	120%	150%	150%+
60-90 days	130%	160%	160%+
30-60 days	140%	170%	170%+
<30 days	150%	180%	180%+
Rationale: When a deadline is imminent, it's better to be overloaded than to miss a statutory deadline. The system relaxes constraints while still flagging the pressure.

Cross-Staff Balancing Suggestions
When one staff member is overloaded but others have capacity:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¡ Alternative Option Available                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚ Jane Smith's August is at 145% capacity.                                â”‚
â”‚                                                                          â”‚
â”‚ Tom Brown has capacity in August (72%).                                 â”‚
â”‚                                                                          â”‚
â”‚ Consider reassigning one of these clients to Tom:                       â”‚
â”‚ â€¢ DEF Ltd (weight 1.0) - similar to Tom's existing portfolio           â”‚
â”‚ â€¢ GHI Ltd (weight 0.5) - straightforward accounts                      â”‚
â”‚                                                                          â”‚
â”‚ [View Tom's Portfolio] [Suggest Reassignment] [Dismiss]                 â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Configurable Tolerance Settings
Thresholds can be adjusted per firm:

// Add to smoothing_settings table
export const smoothingSettings = pgTable("smoothing_settings", {
  id: varchar("id").primaryKey(),
  settingKey: varchar("setting_key").notNull().unique(),
  settingValue: jsonb("setting_value").notNull(),
  description: text("description"),
  updatedAt: timestamp("updated_at").defaultNow(),
});
// Example configuration:
// { key: "green_max_percent", value: 100, description: "Auto-assign up to this %" }
// { key: "amber_max_percent", value: 120, description: "Auto-assign with warning up to this %" }
// { key: "red_max_percent", value: 150, description: "Requires approval up to this %" }
// { key: "enable_dynamic_relaxation", value: true, description: "Relax thresholds near due date" }
// { key: "enable_cross_staff_suggestions", value: true, description: "Suggest rebalancing across staff" }

Early Warning System
The system should warn before problems occur:

NIGHTLY JOB: Capacity Forecast Warnings
1. FOR each client manager:
   a. LOOK at next 3 months of CONFIRMED + PROVISIONAL work
   b. IF any month exceeds amber threshold:
      â†’ WARN: "July is forecast at 125% - consider chasing outstanding docs"
   c. IF multiple months exceed red threshold:
      â†’ ESCALATE: "Q3 capacity crisis forecast - resource review needed"
2. FOR each project in "Gather Documents":
   a. IF provisionally scheduled month is already > 100% AND docs not received:
      â†’ WARN: "ABC Ltd docs still outstanding - their month is filling up"
      â†’ Prompt to chase client or consider alternative months

Integration with Project Types
Linking Services to Project Types
A project type used for smoothable work must be linked to a service that has complexity weighting enabled:

// Add to projectTypes table
linkedServiceId: varchar("linked_service_id").references(() => services.id),
// Links this project type to a service (e.g., "Annual Accounts" service)
// Required when enableWorkloadSmoothing = TRUE
enableWorkloadSmoothing: boolean("enable_workload_smoothing").default(false),
// Only annual accounts and similar flexible work should be smoothed
smoothingLeadTimeDays: integer("smoothing_lead_time_days").default(60),
// Minimum days after year end before work can start
smoothingSafetyBufferDays: integer("smoothing_safety_buffer_days").default(14),
// Days before due date to use as the latest target
// Stage trigger references (required when smoothing enabled)
preWorkStageId: varchar("pre_work_stage_id").references(() => projectTypeStages.id),
// Stage where docs are gathered - triggers PROVISIONAL scheduling
readyQueueStageId: varchar("ready_queue_stage_id").references(() => projectTypeStages.id),
// Stage where work waits - triggers CONFIRMED scheduling
mainWorkStageId: varchar("main_work_stage_id").references(() => projectTypeStages.id),
// Stage when active work begins - triggers IN_PROGRESS status
// Activation status
smoothingConfigComplete: boolean("smoothing_config_complete").default(false),
// System-calculated: TRUE only when all required settings are configured

Activation Validation
A smoothing-enabled project type cannot be used until configuration is complete:

FUNCTION validateSmoothingConfig(projectType):
    
    errors = []
    
    1. IF enableWorkloadSmoothing = FALSE:
       â†’ RETURN valid (not a smoothing project type)
    
    2. CHECK linkedServiceId:
       a. IF null: errors.push("Must link to a service")
       b. IF service.enableComplexityWeighting = FALSE:
          errors.push("Linked service must have complexity weighting enabled")
    
    3. CHECK stage triggers:
       a. IF preWorkStageId null: errors.push("Pre-work stage required")
       b. IF readyQueueStageId null: errors.push("Ready queue stage required")
       c. IF mainWorkStageId null: errors.push("Main work stage required")
    
    4. CHECK stage order:
       a. preWorkStage.order < readyQueueStage.order < mainWorkStage.order
       b. IF not in order: errors.push("Stages must be in sequential order")
    
    5. UPDATE smoothingConfigComplete = (errors.length === 0)
    
    RETURN { valid: errors.length === 0, errors }

Project Type Configuration UI
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Project Type: Annual Accounts                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚ Workload Smoothing Settings                                              â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                              â”‚
â”‚                                                                          â”‚
â”‚ â˜‘ Enable workload smoothing for this project type                       â”‚
â”‚                                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âš  Configuration Incomplete - 2 issues to resolve                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚ Linked Service: [Annual Accounts â–¼] âœ“                                   â”‚
â”‚   â””â”€â”€ Service has complexity weighting enabled âœ“                        â”‚
â”‚                                                                          â”‚
â”‚ Timing Settings:                                                         â”‚
â”‚   Minimum lead time: [60] days after year end                           â”‚
â”‚   Safety buffer: [14] days before due date                              â”‚
â”‚                                                                          â”‚
â”‚ Stage Triggers:                                                          â”‚
â”‚   Pre-work stage:    [Gather Documents â–¼] âœ“                             â”‚
â”‚     â†’ Provisional schedule calculated when project enters               â”‚
â”‚                                                                          â”‚
â”‚   Ready queue stage: [Ready to Start â–¼] âœ“                               â”‚
â”‚     â†’ Confirmed schedule calculated, work held until start date         â”‚
â”‚                                                                          â”‚
â”‚   Main work stage:   [-- Select --    â–¼] âœ— Required                    â”‚
â”‚     â†’ Work begins, schedule status set to "in progress"                 â”‚
â”‚                                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Status: âš  Cannot create projects until configuration complete       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Project Creation Validation
When creating a project using a smoothing-enabled project type:

FUNCTION validateProjectCreation(projectTypeId, clientId):
    
    projectType = getProjectType(projectTypeId)
    
    1. IF projectType.enableWorkloadSmoothing = TRUE:
       a. IF projectType.smoothingConfigComplete = FALSE:
          â†’ REJECT: "Project type configuration incomplete"
       
       b. GET client_service WHERE clientId AND serviceId = projectType.linkedServiceId
          IF not found:
          â†’ REJECT: "Client doesn't have this service assigned"
          
       c. GET serviceOwner from client_service
          IF serviceOwner has no capacity setting AND no owned services:
          â†’ WARN: "No capacity target set for service owner"
    
    2. IF all checks pass:
       â†’ ALLOW creation
       â†’ Calculate provisional schedule immediately

User Interface Components
1. Client Complexity Setting
On the client profile, add a complexity weight selector:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Job Complexity                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Weight: [â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€] 1.0                          â”‚
â”‚         0.5                2.0                               â”‚
â”‚                                                              â”‚
â”‚ â—‹ Minimal (0.5) - Dormant/very simple                       â”‚
â”‚ â— Standard (1.0) - Typical small company                    â”‚
â”‚ â—‹ Moderate (1.5) - Some complexity                          â”‚
â”‚ â—‹ Complex (2.0) - Groups/consolidations                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. Capacity Heatmap Dashboard
A calendar view showing workload distribution:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capacity Overview - Jane Smith (Client Manager)      2025   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Jan   Feb   Mar   Apr   May   Jun   Jul   Aug   Sep   Oct  â”‚
â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”â”‚
â”‚ â”‚2.5â”‚ â”‚2.3â”‚ â”‚2.8â”‚ â”‚2.4â”‚ â”‚2.0â”‚ â”‚2.1â”‚ â”‚1.8â”‚ â”‚2.6â”‚ â”‚3.2â”‚ â”‚2.4â”‚â”‚
â”‚ â”‚â–ˆâ–ˆâ–ˆâ”‚ â”‚â–ˆâ–ˆâ–ˆâ”‚ â”‚â–ˆâ–ˆâ–ˆâ”‚ â”‚â–ˆâ–ˆâ–ˆâ”‚ â”‚â–ˆâ–ˆ â”‚ â”‚â–ˆâ–ˆ â”‚ â”‚â–ˆ  â”‚ â”‚â–ˆâ–ˆâ–ˆâ”‚ â”‚â–ˆâ–ˆâ–ˆâ”‚ â”‚â–ˆâ–ˆâ–ˆâ”‚â”‚
â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜â”‚
â”‚  âœ“     âœ“    âš      âœ“     âœ“     âœ“     â†“     âœ“    âš      âœ“    â”‚
â”‚                                                              â”‚
â”‚ Legend: âœ“ On target  âš  Over 110%  â†“ Under 80%  â–ˆ Utilization â”‚
â”‚                                                              â”‚
â”‚ Target: 2.4 weighted units/month                             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. Project Timeline View
Within a project, show the scheduled timeline with the two-stage pre-work flow:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ABC Ltd - Annual Accounts 2024                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Year End: 31 Dec 2024                                        â”‚
â”‚ Due Date: 30 Sep 2025                                        â”‚
â”‚ Scheduled Month: April 2025  â† Based on capacity analysis   â”‚
â”‚ Weight: 1.5 (Moderate complexity)                            â”‚
â”‚                                                              â”‚
â”‚ Current Stage: [Gather Documents] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                              â”‚
â”‚ Timeline:                                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Jan        Feb        Mar         Apr        May    Sep     â”‚
â”‚  â”‚          â”‚          â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚       â”‚      â”‚
â”‚  â—â•â•â•â•â•â•â•â•â•â•â—â•â•â•â•â•â•â•â•â•â•â—â”€â”€â”€â”€â”€â”¤   WORK   â”œâ”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
â”‚  â”‚  Gather  â”‚  Ready   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚       â”‚      â”‚
â”‚  â”‚  Docs    â”‚  to      â”‚                     â”‚       â”‚      â”‚
â”‚  â”‚          â”‚  Start   â”‚                     â”‚       â”‚      â”‚
â”‚ Year      Move to    Nightly            Target     Due      â”‚
â”‚ End       queue      scheduler                               â”‚
â”‚           when       releases                                â”‚
â”‚           complete   to work                                 â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Flexible window: Feb 2025 - Sep 2025                    â”‚ â”‚
â”‚ â”‚ April selected: lowest capacity month for Jane Smith    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

The scheduled month is calculated at project creation based on capacity, but the actual timing is flexible within the window. Work could theoretically start anywhere from 2 months after year end up until the due date, but the system picks the optimal month to balance workload.

4. New Client Onboarding
When adding a new client, show capacity impact:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Adding: New Client Ltd                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Year End: March                                              â”‚
â”‚ Complexity: 1.5 (Moderate)                                   â”‚
â”‚ Client Manager: Jane Smith                                   â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Suggested Schedule: August 2025                          â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚ Jane's August capacity: 2.1 / 2.4 (88%)                 â”‚ â”‚
â”‚ â”‚ After adding this client: 3.6 / 2.4 (150%) âš            â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚ Alternative months with better capacity:                 â”‚ â”‚
â”‚ â”‚  â€¢ July 2025: 1.8 / 2.4 (75%) â†’ 3.3 / 2.4 (138%)       â”‚ â”‚
â”‚ â”‚  â€¢ June 2025: 2.1 / 2.4 (88%) â†’ 3.6 / 2.4 (150%)       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ [Accept Suggested: August] [Choose Different Month]          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dedicated Capacity Scheduling View
This is a standalone view separate from standard project views, designed specifically for capacity planning and scheduling analysis.

Purpose
Unlike the main project kanban/list views which focus on individual project status, this view provides:

Macro-level capacity visibility across time periods
Heatmap visualisation of workload distribution
Multi-dimensional filtering by service, service owner, time period
Planning tools for identifying capacity issues before they occur
Access Point
Add to main navigation:

Reports â†’ Capacity Planning

Or as a dedicated section:

Capacity â†’ Scheduling View

View Layout
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAPACITY SCHEDULING VIEW                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ Service: [Annual Accounts â–¼] [All Services]                                     â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ Service Owner(s): [â˜‘ Jane Smith] [â˜‘ Tom Brown] [â˜ Sarah Lee] [Select All]      â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ Time Period: [Apr 2025 â–¼] to [Mar 2026 â–¼]  [This Year] [Next 6 Months] [Custom]â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ View Mode: â— Heatmap Timeline  â—‹ Table View  â—‹ Chart View                       â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ Show: [â˜‘ Confirmed] [â˜‘ Provisional] [â˜‘ In Progress]                            â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEATMAP TIMELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ Colour Key: â–‘ <50%  â–’ 50-80%  â–“ 80-100%  â–ˆ 100-120%  â– >120%                   â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚              Apr    May    Jun    Jul    Aug    Sep    Oct    Nov    Dec        â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚ â”‚ â”‚Jane Smithâ”‚  â–“   â”‚  â–ˆ   â”‚  â–’   â”‚  â–’   â”‚  â–“   â”‚  â–   â”‚  â–“   â”‚  â–‘   â”‚  â–’   â”‚    â”‚ â”‚
â”‚ â”‚ â”‚  (2.4/m) â”‚ 2.2  â”‚ 2.8  â”‚ 1.6  â”‚ 1.4  â”‚ 2.1  â”‚ 3.2  â”‚ 2.3  â”‚ 0.8  â”‚ 1.5  â”‚    â”‚ â”‚
â”‚ â”‚ â”‚          â”‚ 92%  â”‚117%  â”‚ 67%  â”‚ 58%  â”‚ 88%  â”‚133%  â”‚ 96%  â”‚ 33%  â”‚ 63%  â”‚    â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤    â”‚ â”‚
â”‚ â”‚ â”‚Tom Brown â”‚  â–’   â”‚  â–“   â”‚  â–“   â”‚  â–ˆ   â”‚  â–’   â”‚  â–“   â”‚  â–’   â”‚  â–“   â”‚  â–“   â”‚    â”‚ â”‚
â”‚ â”‚ â”‚  (2.0/m) â”‚ 1.4  â”‚ 1.8  â”‚ 1.9  â”‚ 2.4  â”‚ 1.2  â”‚ 1.8  â”‚ 1.5  â”‚ 1.7  â”‚ 1.9  â”‚    â”‚ â”‚
â”‚ â”‚ â”‚          â”‚ 70%  â”‚ 90%  â”‚ 95%  â”‚120%  â”‚ 60%  â”‚ 90%  â”‚ 75%  â”‚ 85%  â”‚ 95%  â”‚    â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤    â”‚ â”‚
â”‚ â”‚ â”‚FIRM TOTALâ”‚  â–“   â”‚  â–“   â”‚  â–’   â”‚  â–’   â”‚  â–’   â”‚  â–ˆ   â”‚  â–“   â”‚  â–’   â”‚  â–’   â”‚    â”‚ â”‚
â”‚ â”‚ â”‚  (4.4/m) â”‚ 3.6  â”‚ 4.6  â”‚ 3.5  â”‚ 3.8  â”‚ 3.3  â”‚ 5.0  â”‚ 3.8  â”‚ 2.5  â”‚ 3.4  â”‚    â”‚ â”‚
â”‚ â”‚ â”‚          â”‚ 82%  â”‚105%  â”‚ 80%  â”‚ 86%  â”‚ 75%  â”‚114%  â”‚ 86%  â”‚ 57%  â”‚ 77%  â”‚    â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ Click any cell to see detailed breakdown â†’                                      â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CELL DETAIL (September - Jane Smith) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ September 2025 - Jane Smith                            Capacity: 3.2 / 2.4 (133%)â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONFIRMED (2.5 weight) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚ â”‚                                                                            â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ Client          â”‚ Weight â”‚ Due Date   â”‚ Status         â”‚ Start Date       â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ ABC Ltd         â”‚ 1.5    â”‚ 30 Sep 25  â”‚ Ready to Start â”‚ 01 Sep 25        â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ DEF Ltd         â”‚ 1.0    â”‚ 31 Oct 25  â”‚ Ready to Start â”‚ 15 Sep 25        â”‚  â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PROVISIONAL (0.7 weight) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚ â”‚                                                                            â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ Client          â”‚ Weight â”‚ Due Date   â”‚ Docs Status    â”‚ Days Waiting     â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ GHI Ltd         â”‚ 0.7    â”‚ 30 Nov 25  â”‚ Chasing        â”‚ 14 days          â”‚  â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ âš  September is OVER CAPACITY by 33%                                            â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ Suggested actions:                                                              â”‚ â”‚
â”‚ â”‚ â€¢ DEF Ltd could be moved to October (currently 96%) - has slack until Oct 31   â”‚ â”‚
â”‚ â”‚ â€¢ Consider reassigning ABC Ltd to Tom Brown (September at 90%)                  â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â”‚ [Move DEF Ltd to Oct] [Suggest Reassignment] [Override & Accept]                â”‚ â”‚
â”‚ â”‚                                                                                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Filter Options Detail
Service Filter
// Options:
// - "All Services" - shows all smoothable services combined
// - Individual services where enableComplexityWeighting = TRUE
// 
// When filtered by service, only shows capacity for that service type

Service Owner Filter
// Multi-select checkbox list of all staff who:
// - Have at least one client_service where they are serviceOwnerId
// - AND that service has enableComplexityWeighting = TRUE
//
// Quick buttons:
// - "Select All" / "Clear All"
// - "My Team" (if hierarchies exist)
// - "Just Me" (quick filter to current user)

Time Period Filter
// Preset ranges:
// - "This Year" (current calendar/financial year)
// - "Next 6 Months" (rolling from today)
// - "Next 12 Months" (rolling from today)
// - "Custom" (date pickers for start/end month)
//
// Minimum: 3 months (below this, heatmap loses value)
// Maximum: 24 months (beyond this, data becomes speculative)

View Mode Options
Heatmap Timeline (Default)

Visual grid with colour-coded capacity cells
Best for quick identification of problem months
Click cells for detailed drilldown
Table View

Traditional tabular format
Better for detailed analysis
Sortable columns
Export to Excel capability
Chart View

Bar/line chart of capacity over time
Overlay confirmed vs provisional
Good for presentations/reporting
Show Filters
// Checkboxes to include/exclude:
// - â˜‘ Confirmed (scheduleStatus = 'confirmed')
// - â˜‘ Provisional (scheduleStatus = 'provisional')  
// - â˜‘ In Progress (scheduleStatus = 'in_progress')
// - â˜ Completed (scheduleStatus = 'completed') - usually hidden
//
// When "Provisional" unchecked, shows only committed workload
// Useful for realistic near-term planning

Data Model for View
// API response structure for capacity grid
interface CapacityGridData {
  filters: {
    serviceId: string | null;
    serviceOwnerIds: string[];
    startMonth: string; // "YYYY-MM"
    endMonth: string;
    includeConfirmed: boolean;
    includeProvisional: boolean;
    includeInProgress: boolean;
  };
  
  serviceOwners: Array<{
    userId: string;
    userName: string;
    monthlyCapacity: number; // Their target capacity per month
  }>;
  
  months: Array<{
    yearMonth: string; // "YYYY-MM"
    
    // Per service owner
    byOwner: Record<string, {
      confirmedWeight: number;
      confirmedCount: number;
      provisionalWeight: number;
      provisionalCount: number;
      inProgressWeight: number;
      inProgressCount: number;
      totalWeight: number;
      utilizationPercent: number;
      capacityZone: 'green' | 'amber' | 'red' | 'critical';
    }>;
    
    // Firm totals
    firmTotal: {
      confirmedWeight: number;
      provisionalWeight: number;
      inProgressWeight: number;
      totalWeight: number;
      targetCapacity: number;
      utilizationPercent: number;
    };
  }>;
  
  // For drilldown
  projectsByMonth: Record<string, Record<string, Array<{
    projectId: string;
    clientName: string;
    weight: number;
    dueDate: string;
    scheduleStatus: string;
    suggestedStartDate: string | null;
    confirmedScheduledMonth: string | null;
    provisionalScheduledMonth: string | null;
    currentStage: string;
  }>>>;
}

Interaction Behaviours
Hover on Cell

Shows tooltip with quick stats
"Jane Smith - September: 3.2/2.4 (133%) - 3 projects"
Click on Cell

Opens detailed breakdown panel (as shown above)
Lists all projects scheduled for that month/owner
Shows suggested actions if over capacity
Drag Project (Future Enhancement)

Drag a project from one month to another
System validates: capacity impact, due date constraints
If valid, updates schedule with confirmation
Export Options

"Export to CSV" - raw data for analysis
"Export to PDF" - formatted report for management
"Print View" - optimised for printing
API Endpoints
Capacity Endpoints
GET /api/capacity/:userId
Returns 12-month forward capacity view for a user
GET /api/capacity/firm-wide
Returns 12-month forward capacity view for entire firm
GET /api/capacity/:userId/:yearMonth
Returns detailed breakdown for specific month
POST /api/capacity/targets
Create/update capacity target override for a user/month

Smoothing Endpoints
POST /api/smoothing/calculate-optimal-month
Input: { projectTypeId, clientId, clientManagerId }
Output: { suggestedMonth, alternativeMonths[], capacityImpact }
POST /api/smoothing/assign-month
Input: { projectId, scheduledMonth }
Manually assigns a month (with capacity warnings)
GET /api/smoothing/preview/:clientId
Preview what month would be assigned for a new project

Implementation Plan
Prerequisites Checklist
Before starting implementation, ensure these exist:

 services table exists with service definitions
 client_services mapping table exists
 project_types table with stage references
 project_type_stages (or kanban_stages) table
 User management with staff roles
Phase 1: Data Model Foundation
Duration: 2-3 days

1.1 Add fields to services table

enableComplexityWeighting: boolean("enable_complexity_weighting").default(false)

1.2 Add fields to client_services table

serviceOwnerId: varchar("service_owner_id").references(() => users.id)
complexityWeight: decimal("complexity_weight", { precision: 3, scale: 2 }).default("1.00")

1.3 Add fields to projects table

scheduleStatus: varchar("schedule_status") // 'provisional' | 'confirmed' | 'in_progress' | 'completed' | 'delayed'
provisionalScheduledMonth: varchar("provisional_scheduled_month") // "YYYY-MM"
confirmedScheduledMonth: varchar("confirmed_scheduled_month") // "YYYY-MM"
suggestedStartDate: timestamp("suggested_start_date")
schedulingNotes: text("scheduling_notes")
originalScheduledMonth: varchar("original_scheduled_month")
delayReason: varchar("delay_reason")
schedulingLocked: boolean("scheduling_locked").default(false)
lastAutoMovedAt: timestamp("last_auto_moved_at")
autoMoveCount: integer("auto_move_count").default(0)

1.4 Add fields to project_types table

linkedServiceId: varchar("linked_service_id").references(() => services.id)
enableWorkloadSmoothing: boolean("enable_workload_smoothing").default(false)
smoothingLeadTimeDays: integer("smoothing_lead_time_days").default(60)
smoothingSafetyBufferDays: integer("smoothing_safety_buffer_days").default(14)
preWorkStageId: varchar("pre_work_stage_id").references(() => projectTypeStages.id)
readyQueueStageId: varchar("ready_queue_stage_id").references(() => projectTypeStages.id)
mainWorkStageId: varchar("main_work_stage_id").references(() => projectTypeStages.id)
smoothingConfigComplete: boolean("smoothing_config_complete").default(false)

1.5 Create new tables

staff_service_capacity - Staff capacity settings per service
capacity_targets - Monthly override targets
smoothing_settings - Firm-wide configuration
smoothing_snapshots - Historical tracking
scheduler_config - Scheduler settings
1.6 Run database migrations

Deliverables:

 All schema changes applied
 Migration scripts tested
 Rollback scripts prepared
Phase 2: Core Capacity Logic
Duration: 3-4 days

2.1 Complexity weight functions

// File: server/services/smoothing/complexity.ts
getComplexityWeight(clientServiceId): number  // With default 1.0 fallback
validateComplexityWeight(weight): number      // Clamp to 0.5-2.0 range

2.2 Capacity calculation functions

// File: server/services/smoothing/capacity.ts
getMonthlyCapacity(userId, serviceId): number  // Get target (explicit or default)
calculateCurrentLoad(userId, yearMonth): { confirmed, provisional, total }
calculateUtilization(userId, yearMonth): { percent, zone }
getCapacityForDateRange(userId, startMonth, endMonth): CapacityGridData

2.3 Staff capacity settings CRUD

// File: server/services/smoothing/staffCapacity.ts
getStaffCapacity(userId, serviceId): StaffServiceCapacity | null
setStaffCapacity(userId, serviceId, capacity): void
deleteStaffCapacity(userId, serviceId): void
getDefaultCapacity(userId, serviceId): number  // Sum of weights / 12

Deliverables:

 All capacity functions implemented with tests
 Default fallback logic for missing complexity weights
 Capacity calculation tested with sample data
Phase 3: Scheduling Algorithm
Duration: 4-5 days

3.1 Provisional scheduling (on project creation)

// File: server/services/smoothing/scheduling.ts
assignProvisionalMonth(project, serviceOwnerId): ProvisionalResult
// - Calculate flexible window
// - Find optimal month based on current capacity
// - Assign provisionalScheduledMonth
// - Set scheduleStatus = 'provisional'

3.2 Confirmed scheduling (when docs received)

confirmScheduledMonth(project, serviceOwnerId): ConfirmResult
// - Recalculate based on current real-time capacity
// - Try auto-rebalancing if over capacity
// - Set confirmedScheduledMonth and suggestedStartDate
// - Set scheduleStatus = 'confirmed'

3.3 Auto-rebalancing logic

attemptAutoRebalance(targetMonth, requiredCapacity): RebalanceResult
// - Find moveable projects in targetMonth
// - Move up to 3 projects to make room
// - Return success/failure with moves made

3.4 Tolerance zone enforcement

evaluateCapacityZone(utilizationPercent, daysToDeadline): Zone
// - Apply dynamic threshold relaxation
// - Return zone: 'green' | 'amber' | 'red' | 'critical'
getApprovalRequirement(zone): ApprovalType
// - Return 'auto' | 'warning' | 'approval_required' | 'refused'

3.5 Integration with project creation

// Modify project creation flow:
// 1. Validate project type smoothing config
// 2. Get service owner from client_services
// 3. Call assignProvisionalMonth()
// 4. Save project with provisional schedule

3.6 Integration with stage transitions

// When project moves to readyQueueStage:
// 1. Call confirmScheduledMonth()
// 2. Update project with confirmed schedule
// 3. Trigger notifications if capacity warning

Deliverables:

 Provisional scheduling working on project creation
 Confirmed scheduling on stage transition
 Auto-rebalancing tested with various scenarios
 Tolerance zones correctly applied
Phase 4: Nightly Scheduler
Duration: 2-3 days

4.1 Scheduler job implementation

// File: server/jobs/schedulerJob.ts
// Runs nightly at configured time (default 02:00)
async function runSchedulerJob():
  // 1. Release ready work
  releaseReadyProjects()
  
  // 2. Generate warnings
  generateAtRiskWarnings()
  generateCriticalEscalations()
  
  // 3. Capacity forecast warnings
  generateCapacityForecastWarnings()

4.2 Work release logic

releaseReadyProjects():
// - Find projects in ready_queue where suggestedStartDate <= today
// - Move to main_work stage
// - Notify assignees
// - Log transitions

4.3 Warning generation

generateAtRiskWarnings():
// - Find projects in gather_docs with suggestedStartDate within X days
// - Create warning notifications
generateCriticalEscalations():
// - Find projects with dueDate within Y days not yet in main_work
// - Escalate to management

4.4 Scheduler configuration

Add scheduler_config table entries
Make warning thresholds configurable
Deliverables:

 Nightly job running reliably
 Work released automatically
 Warnings generated correctly
 Escalations working
Phase 5: Configuration UI
Duration: 3-4 days

5.1 Service settings

Services â†’ [Service Name] â†’ Settings
â””â”€â”€ â˜‘ Enable complexity weighting for this service

5.2 Client service complexity setting

Client â†’ Services tab â†’ [Service] â†’ Edit
â””â”€â”€ Complexity weight slider (0.5 - 2.0)

5.3 Staff capacity settings

Settings â†’ Staff Capacity
â””â”€â”€ Grid: Staff Ã— Service with capacity values
    â””â”€â”€ Click to edit annual/monthly capacity

5.4 Project type smoothing configuration

Settings â†’ Project Types â†’ [Type] â†’ Smoothing
â””â”€â”€ Full configuration panel as documented
    â”œâ”€â”€ Link to service
    â”œâ”€â”€ Timing settings
    â””â”€â”€ Stage triggers

5.5 Firm-wide smoothing settings

Settings â†’ Capacity Planning
â””â”€â”€ Tolerance thresholds (green/amber/red/critical)
â””â”€â”€ Enable/disable features (dynamic relaxation, cross-staff suggestions)
â””â”€â”€ Scheduler timing

Deliverables:

 All configuration screens built
 Validation enforced (project type activation)
 Settings persisted correctly
Phase 6: Capacity Scheduling View
Duration: 5-6 days

6.1 Main view component

Reports â†’ Capacity Planning (or Capacity â†’ Scheduling View)

6.2 Filter panel

Service dropdown
Service owner multi-select
Time period selector
View mode toggle
Show checkboxes (confirmed/provisional/in progress)
6.3 Heatmap timeline component

Grid with rows per service owner + firm total
Columns per month
Colour-coded cells by utilization zone
Click handler for drilldown
6.4 Cell detail panel

Shows when cell clicked
Lists projects in confirmed/provisional sections
Shows suggested actions for over-capacity
Action buttons (move, reassign, override)
6.5 Table view mode

Traditional table format
Sortable columns
Filterable
6.6 Chart view mode

Bar chart of capacity over time
Stacked: confirmed + provisional
Line overlay for target capacity
6.7 Export functionality

Export to CSV
Export to PDF
Print view
6.8 API endpoints

GET /api/capacity/grid
POST /api/capacity/move-project
POST /api/capacity/suggest-reassignment

Deliverables:

 Heatmap view working with real data
 All filter options functional
 Cell drilldown showing correct projects
 Actions (move, reassign) working
 Export working
Phase 7: Project Integration
Duration: 2-3 days

7.1 Project detail timeline view

Visual timeline showing flexible window
Current scheduled month highlighted
Stage progression markers
7.2 New client onboarding capacity preview

When adding client + service
Show impact on capacity
Suggest optimal month
7.3 Project list/kanban capacity indicators

Badge showing scheduled month
Warning indicators for over-capacity months
7.4 Stage transition hooks

Trigger scheduling logic on appropriate stage moves
Show confirmation dialogs for capacity-impacting actions
Deliverables:

 Timeline visible on project detail
 Capacity preview on new client
 Indicators on project lists
Phase 8: Notifications & Alerts
Duration: 2-3 days

8.1 Notification types

Project scheduled (provisional)
Project confirmed (docs received)
Project moved (auto-rebalance)
At-risk warning (docs outstanding)
Critical escalation (deadline approaching)
Capacity warning (month over threshold)
8.2 Notification channels

In-app notifications
Email (optional, configurable)
8.3 Approval workflow UI

Modal for red-zone approvals
Options: approve, request extension, reassign, escalate
Deliverables:

 All notification types implemented
 Email delivery working (if enabled)
 Approval workflow functional
Phase 9: Reporting & Analytics
Duration: 2-3 days

9.1 Smoothing snapshots

Nightly capture of capacity state
Historical trend data
9.2 Distribution quality report

Standard deviation of monthly load
Peak month analysis
Before/after comparison
9.3 Scheduling effectiveness report

Projects completed by target date %
Average delay duration
Auto-rebalance success rate
9.4 Dashboard widgets

Capacity summary card
Upcoming capacity warnings
At-risk projects count
Deliverables:

 Snapshot job running nightly
 Reports accessible
 Dashboard widgets working
Phase 10: Testing & Refinement
Duration: 3-4 days

10.1 Unit tests

All capacity calculation functions
Scheduling algorithm edge cases
Tolerance zone logic
10.2 Integration tests

Full project creation â†’ scheduling flow
Stage transition â†’ confirmation flow
Auto-rebalancing scenarios
10.3 End-to-end tests

Complete user journey
Multi-user scenarios
10.4 Performance testing

Capacity grid with large datasets
Nightly job with many projects
10.5 User acceptance testing

Test with real accounting firm scenarios
Gather feedback
Deliverables:

 Test coverage > 80% for core logic
 E2E tests passing
 Performance acceptable
 UAT feedback incorporated
Total Estimated Duration
Phase	Duration
Phase 1: Data Model	2-3 days
Phase 2: Core Capacity Logic	3-4 days
Phase 3: Scheduling Algorithm	4-5 days
Phase 4: Nightly Scheduler	2-3 days
Phase 5: Configuration UI	3-4 days
Phase 6: Capacity Scheduling View	5-6 days
Phase 7: Project Integration	2-3 days
Phase 8: Notifications & Alerts	2-3 days
Phase 9: Reporting & Analytics	2-3 days
Phase 10: Testing & Refinement	3-4 days
TOTAL	28-38 days
Recommended MVP Scope
For initial release, prioritise:

Phase 1: Data Model (required)
Phase 2: Core Capacity Logic (required)
Phase 3: Scheduling Algorithm (required)
Phase 5: Configuration UI (basic)
Phase 6: Capacity Scheduling View (heatmap only)
MVP Duration: ~15-20 days

Defer to post-MVP:

Nightly scheduler (can use manual triggers initially)
Table/chart view modes
Reporting & analytics
Email notifications
Edge Cases & Considerations
Documents Not Ready by Suggested Start Date
When a project's suggestedStartDate approaches but it's still in "Gather Documents" stage:

ESCALATION TIMELINE
14 days before suggestedStartDate:
â”œâ”€â”€ WARNING notification to client manager
â”œâ”€â”€ "ABC Ltd accounts scheduled to start in 14 days - documents still outstanding"
â””â”€â”€ Project flagged with amber indicator on dashboard
7 days before suggestedStartDate:
â”œâ”€â”€ ESCALATION to manager/partner
â”œâ”€â”€ More prominent warning on dashboard
â””â”€â”€ Consider automated chase to client
On suggestedStartDate (docs still missing):
â”œâ”€â”€ Project does NOT auto-release (no documents = can't work)
â”œâ”€â”€ Status changes to "Delayed Start"
â”œâ”€â”€ System logs the delay for reporting
â””â”€â”€ Client manager presented with options:
    â”œâ”€â”€ REQUEST NEW MONTH: Push to next available slot (capacity permitting)
    â”œâ”€â”€ FORCE START: Begin with incomplete docs (not recommended, requires override)
    â””â”€â”€ MARK BLOCKED: Explicitly flag as waiting on client with reason

Key Principle: No documents = no release. The scheduled date is a target, not an automatic trigger if prerequisites aren't met.

Client Leaving - Impact on Capacity
When a client leaves (projects archived):

IMMEDIATE EFFECT:
â”œâ”€â”€ Their scheduled projects are archived/cancelled
â”œâ”€â”€ Capacity for their scheduled months is freed up
â””â”€â”€ No automatic redistribution of other projects (Option A)
VISIBILITY:
â”œâ”€â”€ Dashboard shows reduced load in affected months
â”œâ”€â”€ Example: "April now at 1.8 / 2.4 (75%) - capacity available"
â””â”€â”€ Monthly capacity report highlights the change
NATURAL REBALANCING:
â”œâ”€â”€ New clients joining will be scheduled into freed capacity
â”œâ”€â”€ Algorithm sees lower utilisation and suggests those months
â””â”€â”€ Over time, gaps fill naturally without manual intervention

New Client Joining - Scheduling Into Available Capacity
When a new client joins:

CALCULATION PROCESS:
1. Determine year end and due date
2. Calculate flexible window (earliest start to latest target)
3. Query CURRENT capacity for client manager across that window
   â””â”€â”€ Includes all existing scheduled projects (including those from former clients)
4. Factor in weight of new client
5. Find month with lowest utilisation after adding this client
6. Assign that month as suggestedStartDate
NATURAL EFFECT:
â”œâ”€â”€ If a client recently left, their months show lower utilisation
â”œâ”€â”€ New clients are more likely to be scheduled into those gaps
â””â”€â”€ System self-heals without explicit rebalancing

Optional: Periodic Rebalancing Report
While we use "Lock once assigned" (Option A), a quarterly review report could identify optimisation opportunities:

QUARTERLY REBALANCING REPORT
Summary: Q2 2025 capacity distribution has shifted due to client churn
Months now OVER capacity:
â”œâ”€â”€ September 2025: 3.2 / 2.4 (133%) - 2 clients joined with Sept year ends
â””â”€â”€ Suggestion: Move DEF Ltd (weight 1.0) to August (currently 85%)
Months now UNDER capacity:
â”œâ”€â”€ July 2025: 1.6 / 2.4 (67%) - XYZ Ltd left
â””â”€â”€ Suggestion: Pull forward GHI Ltd from August if client agrees
[View Details] [Dismiss] [Apply Suggestions]

This would be a manual review process, not automatic redistribution.

Urgent/Priority Clients
Some clients may need to be processed immediately regardless of capacity
Consider a "priority override" flag that bypasses smoothing
These still count towards capacity but ignore optimal month logic
Year End Changes
If a client changes their year end, projects need rescheduling
Trigger recalculation of optimal month
Warn if new year end creates capacity issues
Multiple Project Types Per Client
A client might have Annual Accounts AND Corporation Tax
Each should be smoothed independently but could show combined impact
Consider grouping related projects to same month vs. spreading
Staff Changes
When a client manager leaves, their clients transfer to someone else
New manager's capacity recalculates automatically
May create temporary peaks that need manual attention
Success Metrics
Track the effectiveness of smoothing by measuring:

Standard Deviation of Monthly Load

Lower = more even distribution
Compare before/after implementation
Peak Month Reduction

What was the highest month's utilization before vs. after?
Projects Completed by Target Date

Should improve as workload becomes more predictable
Staff Satisfaction

Survey on workload predictability and stress levels
# Campaigns & Pages Communications Module - Architecture Specification

**Document Version:** 1.1  
**Last Updated:** December 2025  
**Status:** Phase 1 Complete - Foundation Implemented

---

## Implementation Status

### Phase 1: Foundation âœ… COMPLETE (December 2025)

**Database Schema (14 tables created):**
- âœ… `contact_preferences` - Category-based opt-out per person
- âœ… `preference_tokens` - Secure database-persisted tokens for preference centre
- âœ… `campaign_templates` - Reusable campaign templates
- âœ… `campaigns` - Core campaign management
- âœ… `campaign_target_criteria` - Client-first targeting filters
- âœ… `campaign_messages` - Multi-channel message content
- âœ… `campaign_recipients` - Resolved recipient list with status tracking
- âœ… `campaign_engagement` - Engagement event tracking
- âœ… `client_engagement_scores` - Per-client scoring
- âœ… `campaign_delivery_queue` - Retry-aware delivery queue
- âœ… `pages` - Page definitions
- âœ… `page_components` - Component blocks with grid layout
- âœ… `page_actions` - Smart action handlers
- âœ… `page_visits` - Page engagement tracking

**Storage Layer (12 modules created):**
- âœ… Campaign storage: `campaignStorage`, `campaignTemplateStorage`, `campaignTargetStorage`, `campaignRecipientStorage`, `campaignMessageStorage`, `campaignDeliveryStorage`, `campaignAnalyticsStorage`
- âœ… Page storage: `pageStorage`, `pageComponentStorage`, `pageActionStorage`, `pageVisitStorage`
- âœ… Contact preferences storage with database-persisted tokens

**API Routes (registered with proper middleware):**
- âœ… `/api/campaigns/*` - Full campaign CRUD and workflow management
- âœ… `/api/pages/*` - Page builder and component management
- âœ… `/api/contact-preferences/*` - Token-based preference management

### Remaining Phases

**Phase 2: Campaign Engine** - Pending
- Targeting engine with all 16+ filter types
- Recipient resolution with duplicate history
- Message composition with merge field rendering
- Email/SMS delivery with retry logic
- Campaign workflow state machine with mandatory preview

**Phase 3: Pages Module** - Pending
- Page builder with 14 component types
- Grid layout system
- Smart actions with OTP verification
- Page personalisation and rendering

**Phase 4: Multi-Step Campaigns** - Pending
- Campaign sequences (steps)
- Behaviour-based progression
- Step scheduling and execution

**Phase 5: Analytics & Polish** - Pending
- Engagement scoring calculation
- Campaign analytics dashboard
- Voice channel integration (Dialora.ai)
- Performance optimisation

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Architecture Overview](#2-architecture-overview)
3. [Data Model](#3-data-model)
4. [Targeting Engine Logic](#4-targeting-engine-logic)
5. [Recipient Resolution Logic](#5-recipient-resolution-logic)
6. [Campaign Lifecycle & State Machine](#6-campaign-lifecycle--state-machine)

All Databases

Production Database
You're viewing your database in read-only.
Enable Editing


SQL console

Database studio

schema:
public
Search...
































































































































































50
0



where
status
equals
pending
Apply
Add filter
Clear filters
All statements executed successfully
All statements executed successfully

# Cron Jobs Documentation

This document outlines all scheduled background jobs in The Link application, including their timings, purposes, and the safety strategies implemented to ensure reliable execution in autoscaled deployments.

---

## Safety Strategies

All cron jobs in the system are wrapped with `wrapCronHandler()` which provides comprehensive protection:

### 1. Distributed Locking (PostgreSQL Advisory Locks)
- Prevents duplicate execution when multiple instances are running (autoscale deployments)
- Uses 31-bit hash of job name for stable lock IDs
- Fail-open design: if lock acquisition fails, job proceeds (graceful degradation for single instance)
- Automatic lock release on completion or error

### 2. Automatic Retries with Exponential Backoff
- Default: 2 retries (3 total attempts)
- Backoff delays: 1s â†’ 2s â†’ 4s
- Errors are caught and logged, never crash the process

### 3. Structured JSON Telemetry
Every job emits machine-parseable telemetry:
```json
{
  "job_name": "string",
  "run_id": "unique-id",
  "timestamp": "ISO8601",
  "status": "started|success|error|skipped|retrying",
  "drift_ms": 0,
  "duration_ms": 0,
  "lock_acquired": true,
  "lock_wait_ms": 0,
  "retry_count": 0,
  "error_message": "string",
  "event_loop": { "p50_ms": 0, "p95_ms": 0, "max_ms": 0 },
  "memory": { "heap_used_mb": 0, "heap_total_mb": 0, "rss_mb": 0 },
  "process_uptime_sec": 0,
  "concurrent_jobs": ["JobA", "JobB"]
}
```

### 4. Event Loop Monitoring
- 20ms resolution delay histogram
- Reports p50, p95, max delays every 5 minutes
- Detects event loop blocking that could affect job execution

### 5. Schedule Staggering
All jobs are offset from :00 to avoid collisions. Heavy jobs (Dashboard Cache, View Cache) are spaced 5+ minutes apart.

### 6. Error Containment
- Jobs never throw errors to the cron scheduler
- All errors are logged with full context
- Process continues running even after job failures

---

## Cron Job Reference

### Nightly Operations (UTC)

| Job Name | Schedule | Timezone | Description |
|----------|----------|----------|-------------|
| **SchedulingOrchestrator** | `0 1 * * *` (01:00) | UTC | Generates recurring projects based on service mappings and schedules. Core business logic for automated project creation. |
| **CHSync** | `0 2 * * *` (02:00) | UTC | Synchronizes company data with Companies House API. Updates registered office, director changes, filing deadlines. |
| **EmailResolver** | `0 3 * * *` (03:00) | UTC | Resolves pending email associations and cleans up orphaned email records. |
| **DashboardCacheOvernight** | `5 3 * * *` (03:05) | Europe/London | Pre-computes dashboard statistics for all users. Heavy database operation. |
| **ActivityCleanup** | `15 4 * * *` (04:15) | UTC | Marks stale sessions as inactive, deletes sessions and login attempts older than 90 days. |
| **ViewCacheMorning** | `20 4 * * *` (04:20) | Europe/London | Warms project view cache for fast page loads. Heavy database operation. |

### Business Hours - UK Time

| Job Name | Schedule | Timezone | Description |
|----------|----------|----------|-------------|
| **SequenceCron** | `15 6 * * *` (06:15) | Europe/London | Progresses multi-step campaign sequences. Moves clients through campaign steps based on timing rules. |

Published your App



Show previous events

9 messages & 48 actions
The application is running successfully. Now let me run the final architect review:
Checkpoint made
37 minutes ago
Improve cron job reliability and add detailed telemetry

Rollback here

Changes

Preview
Worked for 17 minutes
can you review these comments and see if this adds anything of value to the work we're doing? The holes / what Iâ€™d challenge

Locks need to cover all side-effect jobs, not just Dashboard + View Cache
If Reminder Notifications / Sent Items / Query Reminder / SLA Breach run on 2â€“3 instances, youâ€™ll spam people or double-create stuff.

Fix: advisory lock per job (and ideally per scope, e.g. per company if thatâ€™s the unit of work).

â€œMissed executionâ€ warnings wonâ€™t disappear unless you stop relying on exact-time cron
Staggering helps, but Node-cron can still miss by a few seconds under load/GC. Thatâ€™s normal.

Fix: a â€œtick runnerâ€ pattern:

run every 1 minute (or 2 minutes)

inside it: â€œis job due?â€ based on DB last_run_at

acquire advisory lock

run idempotently
This makes â€œ08:00:03â€ vs â€œ08:00:00â€ irrelevant.

You need a hard rule: cron handlers must never crash the process
Given your Neon driver behaviour earlier, one uncaught error can still kill the server.

Fix: every cron handler wrapped:

try/catch

bounded retries

log + mark run status

never throw out of the handler

Telemetry must be actionable
Make sure the logs include:

drift_ms

event_loop_lag p50/p95/max

job duration_ms

lock_acquired true/false (and lock wait time)

db_connect_attempts
Otherwise youâ€™ll drown in â€œwe added telemetryâ€ with nothing you can decide from.

31 minutes ago

2 messages & 2 actions
This is valuable feedback that challenges the completeness of the current implementation. Let me get strategic guidance on addressing these concerns:
I accept your suggestions. Let's go with 1-3 and leave 4 for later.

29 minutes ago

10 messages & 65 actions
Let me update the cron-telemetry with enhanced error handling, retries, and structured JSON telemetry:
Checkpoint made
22 minutes ago
Saved progress at the end of the loop

Rollback here

Changes

Preview
Worked for 7 minutes
Want users to get these changes? Republish this App.

Published
One quick sort of related thing. There's a start up process to hydrate scheduled query reminder data. It's no longer needed. Please remove it.

20 minutes ago

3 messages & 26 actions
Found it. I'll remove the startup hydration process from `query-reminder-cron.ts`:
Checkpoint made
18 minutes ago
Remove unused startup process for query reminder data hydration

Rollback here

Changes

Preview
Worked for 2 minutes
Create me a document called crons.md that outlines every cron job, the timings, what they do and all the safetey strategies we now have.

15 minutes ago

Show 3 more

Created crons.md

Documented cron job configurations
Done! I've created crons.md with comprehensive documentation covering:

All 18 Cron Jobs organized by category:

Nightly operations (Scheduling, Companies House sync, Email resolver, Cache warming)
Business hours jobs (Notifications, Reminders, SLA detection, Sent items scanning)
Weekly jobs (AI analysis, Engagement scoring)
Safety Strategies documented:

Distributed locking with PostgreSQL advisory locks
Automatic retries with exponential backoff (1s â†’ 2s â†’ 4s)
Structured JSON telemetry for monitoring
Event loop monitoring (20ms resolution)
Schedule staggering to avoid collisions
Error containment (never crashes the process)
Extras included:

Visual timeline showing when jobs run throughout the day
Quick reference tables by category
Monitoring patterns and log search queries
Troubleshooting guide for common issues
Checkpoint made
14 minutes ago
Document all scheduled background jobs and their safety features

Rollback here

Changes

Preview
Worked for 1 minute
Checkpoint made
11 minutes ago
â€¢
Free
â€¢
Publish
Published your App

Rollback here

Changes

View preview

Scroll to latest

Make, test, iterateâ€¦

Build

Build




